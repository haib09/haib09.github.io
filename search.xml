<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Cocos CreatoréŸ³é¢‘æ’­æ”¾ç®¡ç†å™¨</title>
      <link href="/Cocos-Creator%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE%E7%AE%A1%E7%90%86%E5%99%A8/"/>
      <url>/Cocos-Creator%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE%E7%AE%A1%E7%90%86%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”±äº Cocos Creator 3.x ç§»é™¤äº† v2.x <code>cc.audioEngine</code> ç³»åˆ—çš„ APIï¼Œç»Ÿä¸€ä½¿ç”¨ AudioSource æ§åˆ¶éŸ³é¢‘æ’­æ”¾ã€‚</p></blockquote><p>æ ¹æ®cocoså®˜ç½‘ç»™çš„ä¾‹å­æŒ‰è‡ªå·±å®é™…ä½¿ç”¨ä¿®æ”¹çš„ä¸€ä¸ªå°å·¥å…·ğŸ”§</p><p>å…ˆçœ‹å®˜ç½‘ç»™çš„ä¾‹å­ï¼Œå®˜æ–¹ç°åœ¨æ¨èä½¿ç”¨çš„æ˜¯<code>audioSource</code>, æ’­æ”¾éŸ³ä¹ç”¨ <code>play</code>, æ’­æ”¾éŸ³æ•ˆç”¨ <code>playOneShot</code>ã€‚ä½†æ˜¯ä¸€ä¸ª<code>audioSource</code>åªèƒ½åŒæ—¶æ“ä½œå•ä¸ªéŸ³é¢‘ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬æœ‰å¤šä¸ªéŸ³é¢‘éœ€è¦åŒæ—¶æ’­æ”¾æ—¶å°±éœ€è¦åšä¸€äº›â€œåŠ å·¥â€äº†ã€‚</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AudioMgr.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Node</span>, <span class="title class_">AudioSource</span>, <span class="title class_">AudioClip</span>, resources, director &#125; <span class="keyword">from</span> <span class="string">&#x27;cc&#x27;</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@en</span></span></span><br><span class="line"><span class="comment"> * this is a sington class for audio play, can be easily called from anywhere in you project.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@zh</span></span></span><br><span class="line"><span class="comment"> * è¿™æ˜¯ä¸€ä¸ªç”¨äºæ’­æ”¾éŸ³é¢‘çš„å•ä»¶ç±»ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°åœ¨é¡¹ç›®çš„ä»»ä½•åœ°æ–¹è°ƒç”¨ã€‚</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AudioMgr</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="attr">_inst</span>: <span class="title class_">AudioMgr</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">inst</span>(): <span class="title class_">AudioMgr</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_inst</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_inst</span> = <span class="keyword">new</span> <span class="title class_">AudioMgr</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_inst</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="attr">_audioSource</span>: <span class="title class_">AudioSource</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">//@en create a node as audioMgr</span></span><br><span class="line">        <span class="comment">//@zh åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ä½œä¸º audioMgr</span></span><br><span class="line">        <span class="keyword">let</span> audioMgr = <span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">        audioMgr.<span class="property">name</span> = <span class="string">&#x27;__audioMgr__&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//@en add to the scene.</span></span><br><span class="line">        <span class="comment">//@zh æ·»åŠ èŠ‚ç‚¹åˆ°åœºæ™¯</span></span><br><span class="line">        director.<span class="title function_">getScene</span>().<span class="title function_">addChild</span>(audioMgr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//@en make it as a persistent node, so it won&#x27;t be destroied when scene change.</span></span><br><span class="line">        <span class="comment">//@zh æ ‡è®°ä¸ºå¸¸é©»èŠ‚ç‚¹ï¼Œè¿™æ ·åœºæ™¯åˆ‡æ¢çš„æ—¶å€™å°±ä¸ä¼šè¢«é”€æ¯äº†</span></span><br><span class="line">        director.<span class="title function_">addPersistRootNode</span>(audioMgr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//@en add AudioSource componrnt to play audios.</span></span><br><span class="line">        <span class="comment">//@zh æ·»åŠ  AudioSource ç»„ä»¶ï¼Œç”¨äºæ’­æ”¾éŸ³é¢‘ã€‚</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_audioSource</span> = audioMgr.<span class="title function_">addComponent</span>(<span class="title class_">AudioSource</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">get</span> <span class="title function_">audioSource</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_audioSource</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@en</span></span></span><br><span class="line"><span class="comment">     * play short audio, such as strikes,explosions</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@zh</span></span></span><br><span class="line"><span class="comment">     * æ’­æ”¾çŸ­éŸ³é¢‘,æ¯”å¦‚ æ‰“å‡»éŸ³æ•ˆï¼Œçˆ†ç‚¸éŸ³æ•ˆç­‰</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sound clip or url for the audio</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> volume </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_">playOneShot</span>(<span class="params">sound: AudioClip | <span class="built_in">string</span>, volume: <span class="built_in">number</span> = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sound <span class="keyword">instanceof</span> <span class="title class_">AudioClip</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_audioSource</span>.<span class="title function_">playOneShot</span>(sound, volume);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            resources.<span class="title function_">load</span>(sound, <span class="function">(<span class="params">err, clip: AudioClip</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">_audioSource</span>.<span class="title function_">playOneShot</span>(clip, volume);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@en</span></span></span><br><span class="line"><span class="comment">     * play long audio, such as the bg music</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@zh</span></span></span><br><span class="line"><span class="comment">     * æ’­æ”¾é•¿éŸ³é¢‘ï¼Œæ¯”å¦‚ èƒŒæ™¯éŸ³ä¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sound clip or url for the sound</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> volume </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_">play</span>(<span class="params">sound: AudioClip | <span class="built_in">string</span>, volume: <span class="built_in">number</span> = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sound <span class="keyword">instanceof</span> <span class="title class_">AudioClip</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_audioSource</span>.<span class="title function_">stop</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_audioSource</span>.<span class="property">clip</span> = sound;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_audioSource</span>.<span class="title function_">play</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">audioSource</span>.<span class="property">volume</span> = volume;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            resources.<span class="title function_">load</span>(sound, <span class="function">(<span class="params">err, clip: AudioClip</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">_audioSource</span>.<span class="title function_">stop</span>();</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">_audioSource</span>.<span class="property">clip</span> = clip;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">_audioSource</span>.<span class="title function_">play</span>();</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">audioSource</span>.<span class="property">volume</span> = volume;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * stop the audio play</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_audioSource</span>.<span class="title function_">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * pause the audio play</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_">pause</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_audioSource</span>.<span class="title function_">pause</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * resume the audio play</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_">resume</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_audioSource</span>.<span class="title function_">play</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬éœ€è¦åšå“ªäº›æ”¹åŠ¨å‘¢ï¼Ÿå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªéŸ³é¢‘å¯¹åº”ä¸€ä¸ª<code>audioSource</code>ï¼Œè¿™é‡Œæˆ‘ç”¨<code>Map</code>å­˜å‚¨äº†éŸ³æ•ˆç»„ä»¶<code>AudioSource</code>ã€‚</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* ä¸€ä¸ªéŸ³é¢‘å¯¹åº”ä¸€ä¸ªaudioSource</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="attr">effectList</span>: <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">AudioSource</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åœ¨æ’­æ”¾éŸ³é¢‘æ—¶ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ’­æ”¾é‚£å°±åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ç”¨æ¥æ§åˆ¶è¯¥éŸ³é¢‘ï¼ŒåŒæ—¶æ·»åŠ <code>AudioSource</code>ç»„ä»¶åˆ°èŠ‚ç‚¹ï¼Œç„¶åæŠŠåŠ è½½å¥½çš„éŸ³é¢‘<code>Clip</code>ç»‘å®šåˆ°<code>AudioSource</code>ç»„ä»¶ä¸Šï¼Œæœ€åå°±æ˜¯å¾€<code>effectList</code>é‡Œ<code>set</code>æ–°åˆ›å»ºçš„éŸ³é¢‘ç»„ä»¶ã€‚è¿™æ ·ä¸€é¡¿æ“ä½œï¼Œç¬¬äºŒæ¬¡æ’­æ”¾æ—¶å°±å¯ä»¥ç›´æ¥å¤ç”¨å·²ç»å­˜åœ¨çš„ç»„ä»¶äº†ï¼ŒèŠ‚çœäº†ç³»ç»Ÿå¼€é”€ã€‚</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">playEffect</span>(<span class="params">sound: <span class="built_in">string</span>, volume: <span class="built_in">number</span> = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">audioSource</span>: <span class="title class_">AudioSource</span> | <span class="literal">undefined</span> = <span class="variable language_">this</span>.<span class="property">effectList</span>.<span class="title function_">get</span>(sound);</span><br><span class="line">    <span class="keyword">if</span> (!audioSource) &#123;</span><br><span class="line">        <span class="keyword">const</span> audioClip = <span class="keyword">await</span> <span class="title class_">BundleManager</span>.<span class="title function_">get</span>().<span class="title function_">loadAudio</span>(sound);</span><br><span class="line">        <span class="keyword">if</span> (!audioClip) <span class="keyword">return</span>;  <span class="comment">// å¦‚æœåŠ è½½éŸ³é¢‘å¤±è´¥ï¼Œåˆ™æå‰è¿”å›</span></span><br><span class="line">        <span class="keyword">const</span> audioNode = <span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">        audioNode.<span class="property">name</span> = sound;</span><br><span class="line">        audioNode.<span class="property">parent</span> = <span class="variable language_">this</span>.<span class="property">audioMgr</span>;</span><br><span class="line">        audioSource = audioNode.<span class="title function_">addComponent</span>(<span class="title class_">AudioSource</span>);</span><br><span class="line">        audioSource.<span class="property">name</span> = sound;</span><br><span class="line">        audioSource.<span class="property">clip</span> = audioClip;</span><br><span class="line">        audioSource.<span class="property">volume</span> = volume;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">effectList</span>.<span class="title function_">set</span>(sound, audioSource);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (audioSource.<span class="property">clip</span>) &#123;</span><br><span class="line">        <span class="comment">//æ’­æ”¾çŸ­éŸ³æ•ˆä½¿ç”¨playOneShot</span></span><br><span class="line">        audioSource.<span class="title function_">playOneShot</span>(audioSource.<span class="property">clip</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆé•¿éŸ³é¢‘è¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p><p>æˆ‘è¿™é‡Œä»¥èƒŒæ™¯éŸ³ä¹ä¸¾ä¾‹ï¼Œé¦–å…ˆå®šä¹‰ä¸€ä¸ªå±æ€§ğŸ˜‚</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * èƒŒæ™¯éŸ³</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="attr">bgMusic</span>: <span class="title class_">AudioSource</span></span><br></pre></td></tr></table></figure><p>å¾ˆç®€å•ï¼Œç›´æ¥çœ‹ä»£ç </p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">playMusic</span>(<span class="params">sound: <span class="built_in">string</span>, loop: <span class="built_in">boolean</span> = <span class="literal">true</span>, volume: <span class="built_in">number</span> = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">bgMusic</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> audioClip = <span class="keyword">await</span> <span class="title class_">BundleManager</span>.<span class="title function_">get</span>().<span class="title function_">loadAudio</span>(sound);</span><br><span class="line">        <span class="keyword">if</span> (!audioClip) <span class="keyword">return</span>;  <span class="comment">// å¦‚æœåŠ è½½éŸ³é¢‘å¤±è´¥ï¼Œåˆ™æå‰è¿”å›</span></span><br><span class="line">        <span class="keyword">const</span> audioNode = <span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">        audioNode.<span class="property">name</span> = sound;</span><br><span class="line">        audioNode.<span class="property">parent</span> = <span class="variable language_">this</span>.<span class="property">audioMgr</span>;</span><br><span class="line">        <span class="keyword">const</span> audioSource = audioNode.<span class="title function_">addComponent</span>(<span class="title class_">AudioSource</span>);</span><br><span class="line">        audioSource.<span class="property">name</span> = sound;</span><br><span class="line">        audioSource.<span class="property">clip</span> = audioClip;</span><br><span class="line">        audioSource.<span class="property">volume</span> = volume;</span><br><span class="line">        audioSource.<span class="property">loop</span> = loop;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">bgMusic</span> = audioSource</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">bgMusic</span>.<span class="property">clip</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">bgMusic</span>.<span class="title function_">play</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå®Œæ•´ä»£ç å¥‰ä¸Š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Node</span>, <span class="title class_">AudioSource</span>, director &#125; <span class="keyword">from</span> <span class="string">&#x27;cc&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">BundleManager</span> <span class="keyword">from</span> <span class="string">&#x27;../bundle/BundleManager&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AudioManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="attr">_inst</span>: <span class="title class_">AudioManager</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">inst</span>(): <span class="title class_">AudioManager</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_inst</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_inst</span> = <span class="keyword">new</span> <span class="title class_">AudioManager</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_inst</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * éŸ³é¢‘rootèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="attr">audioMgr</span>: <span class="title class_">Node</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸€ä¸ªéŸ³é¢‘å¯¹åº”ä¸€ä¸ªaudioSource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="attr">effectList</span>: <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">AudioSource</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èƒŒæ™¯éŸ³</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="attr">bgMusic</span>: <span class="title class_">AudioSource</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">audioMgr</span> = <span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">audioMgr</span>.<span class="property">name</span> = <span class="string">&#x27;__audioMgr__&#x27;</span>;</span><br><span class="line">        director.<span class="title function_">getScene</span>().<span class="title function_">addChild</span>(<span class="variable language_">this</span>.<span class="property">audioMgr</span>);</span><br><span class="line">        director.<span class="title function_">addPersistRootNode</span>(<span class="variable language_">this</span>.<span class="property">audioMgr</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">playEffect</span>(<span class="params">sound: <span class="built_in">string</span>, volume: <span class="built_in">number</span> = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">audioSource</span>: <span class="title class_">AudioSource</span> | <span class="literal">undefined</span> = <span class="variable language_">this</span>.<span class="property">effectList</span>.<span class="title function_">get</span>(sound);</span><br><span class="line">        <span class="keyword">if</span> (!audioSource) &#123;</span><br><span class="line">            <span class="keyword">const</span> audioClip = <span class="keyword">await</span> <span class="title class_">BundleManager</span>.<span class="title function_">get</span>().<span class="title function_">loadAudio</span>(sound);</span><br><span class="line">            <span class="keyword">if</span> (!audioClip) <span class="keyword">return</span>;  <span class="comment">// å¦‚æœåŠ è½½éŸ³é¢‘å¤±è´¥ï¼Œåˆ™æå‰è¿”å›</span></span><br><span class="line">            <span class="keyword">const</span> audioNode = <span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">            audioNode.<span class="property">name</span> = sound;</span><br><span class="line">            audioNode.<span class="property">parent</span> = <span class="variable language_">this</span>.<span class="property">audioMgr</span>;</span><br><span class="line">            audioSource = audioNode.<span class="title function_">addComponent</span>(<span class="title class_">AudioSource</span>);</span><br><span class="line">            audioSource.<span class="property">name</span> = sound;</span><br><span class="line">            audioSource.<span class="property">clip</span> = audioClip;</span><br><span class="line">            audioSource.<span class="property">volume</span> = volume;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">effectList</span>.<span class="title function_">set</span>(sound, audioSource);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (audioSource.<span class="property">clip</span>) &#123;</span><br><span class="line">            audioSource.<span class="title function_">play</span>();</span><br><span class="line">            <span class="comment">// audioSource.playOneShot(audioSource.clip);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">playMusic</span>(<span class="params">sound: <span class="built_in">string</span>, loop: <span class="built_in">boolean</span> = <span class="literal">true</span>, volume: <span class="built_in">number</span> = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">bgMusic</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> audioClip = <span class="keyword">await</span> <span class="title class_">BundleManager</span>.<span class="title function_">get</span>().<span class="title function_">loadAudio</span>(sound);</span><br><span class="line">            <span class="keyword">if</span> (!audioClip) <span class="keyword">return</span>;  <span class="comment">// å¦‚æœåŠ è½½éŸ³é¢‘å¤±è´¥ï¼Œåˆ™æå‰è¿”å›</span></span><br><span class="line">            <span class="keyword">const</span> audioNode = <span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">            audioNode.<span class="property">name</span> = sound;</span><br><span class="line">            audioNode.<span class="property">parent</span> = <span class="variable language_">this</span>.<span class="property">audioMgr</span>;</span><br><span class="line">            <span class="keyword">const</span> audioSource = audioNode.<span class="title function_">addComponent</span>(<span class="title class_">AudioSource</span>);</span><br><span class="line">            audioSource.<span class="property">name</span> = sound;</span><br><span class="line">            audioSource.<span class="property">clip</span> = audioClip;</span><br><span class="line">            audioSource.<span class="property">volume</span> = volume;</span><br><span class="line">            audioSource.<span class="property">loop</span> = loop;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">bgMusic</span> = audioSource</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">bgMusic</span>.<span class="property">clip</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">bgMusic</span>.<span class="title function_">play</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">stopMusic</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">bgMusic</span> || !<span class="variable language_">this</span>.<span class="property">bgMusic</span>.<span class="property">playing</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">bgMusic</span>.<span class="title function_">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">stopEffect</span>(<span class="attr">sound</span>: <span class="built_in">string</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">audioSource</span>: <span class="title class_">AudioSource</span> | <span class="literal">undefined</span> = <span class="variable language_">this</span>.<span class="property">effectList</span>.<span class="title function_">get</span>(sound);</span><br><span class="line">        <span class="keyword">if</span> (!audioSource || !audioSource.<span class="property">playing</span>) <span class="keyword">return</span>;</span><br><span class="line">        audioSource.<span class="title function_">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> cocos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHPä½¿ç”¨Rediså®ç°åˆ†å¸ƒå¼é”</title>
      <link href="/PHP%E4%BD%BF%E7%94%A8-Redis-%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
      <url>/PHP%E4%BD%BF%E7%94%A8-Redis-%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
      
        <content type="html"><![CDATA[<h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œåˆ†å¸ƒå¼é”æ˜¯ç¡®ä¿èµ„æºäº’æ–¥è®¿é—®çš„é‡è¦æœºåˆ¶ã€‚æˆ‘ä»¬åœ¨ç³»ç»Ÿä¸­ä¿®æ”¹å·²æœ‰æ•°æ®æ—¶ï¼Œéœ€è¦å…ˆè¯»å–ï¼Œç„¶åè¿›è¡Œä¿®æ”¹ä¿å­˜ï¼Œæ­¤æ—¶å¾ˆå®¹æ˜“é‡åˆ°å¹¶å‘é—®é¢˜ã€‚ç”±äºä¿®æ”¹å’Œä¿å­˜ä¸æ˜¯åŸå­æ“ä½œï¼Œåœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œéƒ¨åˆ†å¯¹æ•°æ®çš„æ“ä½œå¯èƒ½ä¼šä¸¢å¤±ã€‚åœ¨å•æœåŠ¡å™¨ç³»ç»Ÿæˆ‘ä»¬å¸¸ç”¨æœ¬åœ°é”æ¥é¿å…å¹¶å‘å¸¦æ¥çš„é—®é¢˜ï¼Œç„¶è€Œï¼Œå½“æœåŠ¡é‡‡ç”¨é›†ç¾¤æ–¹å¼éƒ¨ç½²æ—¶ï¼Œæœ¬åœ°é”æ— æ³•åœ¨å¤šä¸ªæœåŠ¡å™¨ä¹‹é—´ç”Ÿæ•ˆï¼Œè¿™æ—¶å€™ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å°±éœ€è¦åˆ†å¸ƒå¼é”æ¥å®ç°ã€‚</p><h3 id="å®ç°æ–¹å¼"><a href="#å®ç°æ–¹å¼" class="headerlink" title="å®ç°æ–¹å¼"></a>å®ç°æ–¹å¼</h3><p>é€šè¿‡ Redis çš„ <code>SET</code> å’Œ <code>DEL</code> å‘½ä»¤å®ç°é”çš„è®¾ç½®å’Œé‡Šæ”¾ï¼Œå¹¶ä½¿ç”¨ Lua è„šæœ¬ç¡®ä¿æ“ä½œçš„åŸå­æ€§ã€‚</p><ul><li><p>åŠ é”å‘½ä»¤ï¼š<code>SETNX key value</code>ï¼Œå½“é”®ä¸å­˜åœ¨æ—¶ï¼Œå¯¹é”®è¿›è¡Œè®¾ç½®æ“ä½œå¹¶è¿”å›æˆåŠŸï¼Œå¦åˆ™è¿”å›å¤±è´¥ã€‚KEY æ˜¯é”çš„å”¯ä¸€æ ‡è¯†ï¼Œä¸€èˆ¬æŒ‰ä¸šåŠ¡æ¥å†³å®šå‘½åã€‚</p></li><li><p>è§£é”å‘½ä»¤ï¼š<code>DEL key</code>ï¼Œé€šè¿‡åˆ é™¤é”®å€¼å¯¹é‡Šæ”¾é”ï¼Œä»¥ä¾¿å…¶ä»–çº¿ç¨‹å¯ä»¥é€šè¿‡ SETNX å‘½ä»¤æ¥è·å–é”ã€‚</p></li><li><p>é”è¶…æ—¶ï¼š<code>EXPIRE key timeout</code>, è®¾ç½® key çš„è¶…æ—¶æ—¶é—´ï¼Œä»¥ä¿è¯å³ä½¿é”æ²¡æœ‰è¢«æ˜¾å¼é‡Šæ”¾ï¼Œé”ä¹Ÿå¯ä»¥åœ¨ä¸€å®šæ—¶é—´åè‡ªåŠ¨é‡Šæ”¾ï¼Œé¿å…èµ„æºè¢«æ°¸è¿œé”ä½ã€‚</p></li></ul><p>ä»¥ä¸‹æ˜¯è¯¦ç»†çš„ä»£ç åˆ†æï¼š</p><h3 id="è·å–é”"><a href="#è·å–é”" class="headerlink" title="è·å–é”"></a>è·å–é”</h3><p><code>getLock</code> æ–¹æ³•å°è¯•è·å–é”ã€‚å®ƒä½¿ç”¨ Redis çš„ <code>SET</code> å‘½ä»¤ï¼Œå¹¶é€šè¿‡ Lua è„šæœ¬ç¡®ä¿æ“ä½œçš„åŸå­æ€§ã€‚å…³é”®ç‚¹å¦‚ä¸‹ï¼š</p><ul><li><strong>é”è¶…æ—¶</strong>ï¼šè®¾ç½® key çš„è¶…æ—¶æ—¶é—´ï¼Œä»¥ä¿è¯å³ä½¿é”æ²¡æœ‰è¢«æ˜¾å¼é‡Šæ”¾ï¼Œé”ä¹Ÿå¯ä»¥åœ¨ä¸€å®šæ—¶é—´åè‡ªåŠ¨é‡Šæ”¾ï¼Œé¿å…èµ„æºè¢«æ°¸è¿œé”ä½ã€‚</li><li><strong>å”¯ä¸€å€¼ç”Ÿæˆ</strong>ï¼šä½¿ç”¨ <code>md5(uniqid(&#39;&#39;, true))</code> ç”Ÿæˆå”¯ä¸€çš„é”å€¼ï¼Œåœ¨åé¢é‡Šæ”¾é”æ—¶éœ€è¦ç”¨åˆ°ã€‚</li><li><strong>åŸå­æ€§</strong>ï¼š<code>SET</code> å‘½ä»¤ç»“åˆ <code>NX</code> å’Œ <code>EX</code> é€‰é¡¹ç¡®ä¿é”çš„å”¯ä¸€æ€§å’Œè¿‡æœŸæ—¶é—´ã€‚Lua è„šæœ¬é¿å…äº†å¤šå‘½ä»¤æ“ä½œçš„å¹¶å‘é—®é¢˜ã€‚</li><li><strong>é‡è¯•æœºåˆ¶</strong>ï¼šå¦‚æœé”è·å–å¤±è´¥ï¼Œæ–¹æ³•ä¼šè‡ªæ—‹é‡è¯•ï¼Œç›´åˆ°è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚æ¯æ¬¡é‡è¯•ä¹‹é—´ï¼Œçº¿ç¨‹ä¼šç­‰å¾… 200 æ¯«ç§’ã€‚</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * è·å–é”ï¼Œæ”¯æŒè‡ªæ—‹</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span>  string  $lockKey</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span>  int     $ttl           è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span>  int     $max_attempts  æœ€å¤§é‡è¯•æ¬¡æ•°</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> string|null</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getLock</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$lockKey</span>, <span class="keyword">int</span> <span class="variable">$ttl</span> = <span class="number">20</span>, <span class="keyword">int</span> <span class="variable">$max_attempts</span> = <span class="number">10</span></span>): ?<span class="title">string</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="variable">$key</span> = <span class="built_in">self</span>::<span class="variable constant_">LOCK_PREFIX</span>.<span class="variable">$lockKey</span>;</span><br><span class="line">  <span class="variable">$uniqueValue</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">uniqid</span>(<span class="string">&#x27;&#x27;</span>, <span class="literal">true</span>)); <span class="comment">// ç”Ÿæˆå”¯ä¸€çš„é”å€¼</span></span><br><span class="line">  <span class="variable">$attempts</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="variable">$attempts</span> &lt; <span class="variable">$max_attempts</span>) &#123;</span><br><span class="line">    <span class="variable">$luaScript</span> = <span class="string">&lt;&lt;&lt;SCRIPT</span></span><br><span class="line"><span class="string">            if redis.call(&#x27;SET&#x27;, KEYS[1], ARGV[1], &#x27;NX&#x27;, &#x27;EX&#x27;, ARGV[2]) then</span></span><br><span class="line"><span class="string">                return true</span></span><br><span class="line"><span class="string">            else</span></span><br><span class="line"><span class="string">                return false</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">SCRIPT</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$result</span> = <span class="title class_">Redis</span>::<span class="keyword">eval</span>(<span class="variable">$luaScript</span>, <span class="number">1</span>, <span class="variable">$key</span>, <span class="variable">$uniqueValue</span>, <span class="variable">$ttl</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$result</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable">$uniqueValue</span>; <span class="comment">// æˆåŠŸè·å–é”</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">usleep</span>(<span class="number">200</span> * <span class="number">1000</span>); <span class="comment">// ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼ˆå¾®ç§’ï¼‰</span></span><br><span class="line">    <span class="variable">$attempts</span>++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åä»æœªè·å–åˆ°é”</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é‡Šæ”¾é”"><a href="#é‡Šæ”¾é”" class="headerlink" title="é‡Šæ”¾é”"></a>é‡Šæ”¾é”</h3><p><code>releaseLock</code> æ–¹æ³•ç”¨äºé‡Šæ”¾é”ã€‚å®ƒé€šè¿‡ Lua è„šæœ¬å®ç°ï¼Œç¡®ä¿åªæœ‰æŒæœ‰é”çš„å®¢æˆ·ç«¯æ‰èƒ½é‡Šæ”¾é”ã€‚å…³é”®ç‚¹å¦‚ä¸‹ï¼š</p><ul><li><strong>é”è¯¯è§£é™¤</strong>ï¼šå¦‚æœçº¿ç¨‹ A æˆåŠŸè·å–åˆ°äº†é”ï¼Œå¹¶ä¸”è®¾ç½®äº†è¿‡æœŸæ—¶é—´ 30 ç§’ï¼Œä½†çº¿ç¨‹ A æ‰§è¡Œæ—¶é—´è¶…è¿‡äº† 30 ç§’ï¼Œé”è¿‡æœŸè‡ªåŠ¨é‡Šæ”¾ï¼Œæ­¤æ—¶çº¿ç¨‹ B è·å–åˆ°äº†é”ï¼›éšå A æ‰§è¡Œå®Œæˆï¼Œçº¿ç¨‹ A ä½¿ç”¨ DEL å‘½ä»¤æ¥é‡Šæ”¾é”ï¼Œä½†æ­¤æ—¶çº¿ç¨‹ B åŠ çš„é”è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæˆï¼Œçº¿ç¨‹ A å®é™…é‡Šæ”¾çš„çº¿ç¨‹ B åŠ çš„é”ã€‚æ‰€ä»¥æˆ‘ä»¬è¦è·å–å½“å‰é”çš„å€¼å¹¶æ£€æŸ¥æ˜¯å¦ä¸ä¼ å…¥çš„ <code>lockValue</code> åŒ¹é…ã€‚å¦‚æœåŒ¹é…ï¼Œåˆ™æ‰§è¡Œ <code>DEL</code> å‘½ä»¤é‡Šæ”¾é”ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢è¯¯åˆ å…¶ä»–å®¢æˆ·ç«¯æŒæœ‰çš„é”ã€‚</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">releaseLock</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$lockKey</span>, <span class="keyword">string</span> <span class="variable">$lockValue</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="variable">$key</span> = <span class="built_in">self</span>::<span class="variable constant_">LOCK_PREFIX</span>.<span class="variable">$lockKey</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$luaScript</span> = <span class="string">&lt;&lt;&lt;SCRIPT</span></span><br><span class="line"><span class="string">        if redis.call(&#x27;GET&#x27;, KEYS[1]) == ARGV[1] then</span></span><br><span class="line"><span class="string">            return redis.call(&#x27;DEL&#x27;, KEYS[1])</span></span><br><span class="line"><span class="string">        else</span></span><br><span class="line"><span class="string">            return 0</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string">SCRIPT</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$result</span> = <span class="title class_">Redis</span>::<span class="keyword">eval</span>(<span class="variable">$luaScript</span>, <span class="number">1</span>, <span class="variable">$key</span>, <span class="variable">$lockValue</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$result</span> === <span class="number">1</span>; <span class="comment">// è¿”å›å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦æˆåŠŸé‡Šæ”¾é”</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>è·å–äº†é”ä¹‹åä¸€å®šè¦é‡Šæ”¾é”ï¼Œæ‰€ä»¥ç”¨try  finallyçš„é”™è¯¯æ•è·æ–¹æ³•ä¿è¯ä¸ç®¡åœ¨è·å–é”ä¹‹åæ˜¯å¦å‘ç”Ÿé”™è¯¯ï¼Œæœ€åéƒ½ä¼šé‡Šæ”¾é”ï¼Œè¿™æ˜¯å®‰å…¨ä½¿ç”¨é”çš„ä¸€ç§å§¿åŠ¿ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$lockKey</span> = <span class="string">&#x27;xxx&#x27;</span>;<span class="comment">//ä¸šåŠ¡key</span></span><br><span class="line"><span class="variable">$lockValue</span> = <span class="title class_">RedisLockService</span>::<span class="title function_ invoke__">getInstance</span>()-&gt;<span class="title function_ invoke__">getLock</span>(<span class="variable">$lockKey</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$lockValue</span>) &#123;</span><br><span class="line">    <span class="comment">//æ²¡æœ‰æ‹¿åˆ°key</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°é”åå¤„ç†ä¸šåŠ¡</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    <span class="title class_">RedisLockService</span>::<span class="title function_ invoke__">getInstance</span>()-&gt;<span class="title function_ invoke__">releaseLock</span>(<span class="variable">$lockKey</span>, <span class="variable">$lockValue</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enjoy it</p>]]></content>
      
      
      
        <tags>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cocos Creator æ„å»ºé«˜æ•ˆçš„æ•°æ®é©±åŠ¨äº‹ä»¶ç³»ç»Ÿ</title>
      <link href="/Cocos-Creator-%E6%9E%84%E5%BB%BA%E9%AB%98%E6%95%88%E7%9A%84%E6%95%B0%E6%8D%AE%E9%A9%B1%E5%8A%A8%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
      <url>/Cocos-Creator-%E6%9E%84%E5%BB%BA%E9%AB%98%E6%95%88%E7%9A%84%E6%95%B0%E6%8D%AE%E9%A9%B1%E5%8A%A8%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
      
        <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>åœ¨æ¸¸æˆå¼€å‘ä¸­ï¼Œå¸¸å¸¸éœ€è¦å¤„ç†å¤æ‚çš„æ•°æ®äº¤äº’å’Œäº‹ä»¶å“åº”ï¼Œå°¤å…¶æ˜¯åœ¨ç»„ä»¶åŒ–çš„ç¯å¢ƒä¸­ã€‚ä¸ºäº†å®ç°è¿™ç§éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé«˜æ•ˆçš„äº‹ä»¶è°ƒåº¦ç³»ç»Ÿæ¥å¤„ç†æ•°æ®å˜åŒ–å’ŒèŠ‚ç‚¹çŠ¶æ€ã€‚Cocos Creator ä½œä¸ºä¸€ä¸ªæµè¡Œçš„æ¸¸æˆå¼•æ“ï¼Œæä¾›äº†ä¸°å¯Œçš„ç»„ä»¶ç³»ç»Ÿå’Œäº‹ä»¶æœºåˆ¶ï¼Œä½†å¼€å‘è€…æœ‰æ—¶éœ€è¦è‡ªå®šä¹‰æ›´çµæ´»çš„è§£å†³æ–¹æ¡ˆã€‚</p><h2 id="StData-æ¨¡å—"><a href="#StData-æ¨¡å—" class="headerlink" title="StData æ¨¡å—"></a><code>StData</code> æ¨¡å—</h2><p><code>StData</code> æ¨¡å—è´Ÿè´£æ•°æ®çš„å­˜å–ã€ç›‘å¬ä»¥åŠæ¸…ç†æ“ä½œã€‚å®ƒä½¿ç”¨äº†ä¸€ç§åŸºäºè·¯å¾„çš„å­˜å‚¨æ–¹å¼æ¥ç®¡ç†æ•°æ®ï¼Œå¹¶é€šè¿‡äº‹ä»¶è°ƒåº¦å™¨æ¥å¤„ç†æ•°æ®å˜åŒ–çš„é€šçŸ¥ã€‚</p><ul><li><strong>è·å–æ•°æ®</strong>ï¼š<code>get(path: string, dv?: any)</code><ul><li>æ ¹æ®è·¯å¾„ä»ç¼“å­˜ä¸­è·å–æ•°æ®ï¼Œå¦‚æœè·¯å¾„ä¸å­˜åœ¨åˆ™è¿”å›é»˜è®¤å€¼ã€‚</li></ul></li><li><strong>è®¾ç½®æ•°æ®</strong>ï¼š<code>set&lt;T&gt;(path: string, v: T, ignoreEvent?: boolean)</code><ul><li>æ ¹æ®è·¯å¾„è®¾ç½®æ•°æ®ï¼Œå¹¶å¯é€‰æ‹©æ˜¯å¦è§¦å‘äº‹ä»¶ã€‚</li></ul></li><li><strong>ç›‘å¬æ•°æ®å˜åŒ–</strong>: <code>listen(path, node, func)</code><ul><li>ç›‘å¬æ•°æ®çš„å˜åŒ–ï¼Œå¹¶åœ¨æ•°æ®æ”¹å˜æ—¶è°ƒç”¨æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚</li></ul></li><li><strong>å–æ¶ˆç›‘å¬</strong>ï¼š<code>unlisten(path, node)</code><ul><li>å–æ¶ˆå¯¹æŸä¸ªæ•°æ®è·¯å¾„çš„ç›‘å¬ã€‚</li></ul></li><li><strong>æ¸…é™¤æ•°æ®</strong>ï¼š<code>clear()</code><ul><li>æ¸…ç©ºæ‰€æœ‰ç¼“å­˜çš„æ•°æ®</li></ul></li></ul><h2 id="Datar-æ¨¡å—"><a href="#Datar-æ¨¡å—" class="headerlink" title="Datar æ¨¡å—"></a><code>Datar</code> æ¨¡å—</h2><p><code>Datar</code> å‘½åç©ºé—´å°è£…äº†å¯¹ <code>StData</code> æ¨¡å—çš„æ“ä½œï¼Œæä¾›äº†ä¸€äº›ä¾¿æ·çš„æ¥å£æ¥ç®€åŒ–æ•°æ®ç®¡ç†å·¥ä½œã€‚å®ƒçš„åŠŸèƒ½åŒ…æ‹¬ï¼š</p><ul><li><strong>è·å–æ•°æ®</strong>ï¼š<code>get&lt;T extends keyof DatarList&gt;(key: T): DatarList[T]</code></li><li><strong>è®¾ç½®æ•°æ®</strong>ï¼š<code>set&lt;T extends keyof DatarList&gt;(key: T, value: DatarList[T]): void</code></li><li><strong>ç›‘å¬æ•°æ®</strong>ï¼š<code>listen&lt;T extends keyof DatarList&gt;(key: T, node: Node, call: (value: DatarList[T]) =&gt; void): void</code></li><li><strong>å–æ¶ˆç›‘å¬</strong>ï¼š<code>unlisten&lt;T extends keyof DatarList&gt;(key: T, node: Node): void</code></li><li><strong>ç›‘å¬æ•°æ®</strong>ï¼š<code>listenget&lt;T extends keyof DatarList&gt;(key: T, dv: any, node: Node, call: (value: DatarList[T]) =&gt; void): void</code><ul><li>ç›¸æ¯”<code>listen</code>æœ‰ä»¥ä¸‹ç‰¹ç‚¹<ul><li>é™¤äº†è®¾ç½®ç›‘å¬å™¨ï¼Œè¿˜ä¼šç«‹å³è·å–å½“å‰æ•°æ®çš„å€¼ï¼Œå¹¶å°†å…¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™å›è°ƒå‡½æ•°</li><li>å¦‚æœè·¯å¾„ä¸å­˜åœ¨ï¼Œä½¿ç”¨æä¾›çš„é»˜è®¤å€¼ <code>dv</code></li><li>é€‚åˆäºéœ€è¦åœ¨æ³¨å†Œç›‘å¬çš„åŒæ—¶è·å–æ•°æ®å½“å‰å€¼çš„åœºæ™¯ï¼Œæ¯”å¦‚åœ¨åˆå§‹åŒ–æ—¶éœ€è¦å…ˆå±•ç¤ºå½“å‰æ•°æ®ï¼Œç„¶åå†å¤„ç†åç»­çš„å˜åŒ–</li></ul></li></ul></li></ul><p>ç¤ºä¾‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Datar</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./Datar&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Node</span> &#125; <span class="keyword">from</span> <span class="string">&quot;cc&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ•°æ®</span></span><br><span class="line"><span class="title class_">Datar</span>.<span class="title function_">set</span>(<span class="string">&quot;game/selectroom&quot;</span>, <span class="string">&quot;room2&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ•°æ®</span></span><br><span class="line"><span class="keyword">const</span> room = <span class="title class_">Datar</span>.<span class="title function_">get</span>(<span class="string">&quot;game/selectroom&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬æ•°æ®å˜åŒ–</span></span><br><span class="line"><span class="title class_">Datar</span>.<span class="title function_">listen</span>(<span class="string">&quot;game/selectroom&quot;</span>, someNode, <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Room changed to:&quot;</span>, value);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬æ•°æ®å˜åŒ–</span></span><br><span class="line"><span class="title class_">Datar</span>.<span class="title function_">listenget</span>(<span class="string">&quot;game/selectroom&quot;</span>, <span class="string">&#x27;default_value&#x27;</span>, <span class="variable language_">this</span>.<span class="property">node</span>, <span class="function">(<span class="params">gameInfo</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;gameInfo=&gt;&#x27;</span>, gameInfo);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="stEventDispatcher-æ¨¡å—"><a href="#stEventDispatcher-æ¨¡å—" class="headerlink" title="stEventDispatcher æ¨¡å—"></a><code>stEventDispatcher</code> æ¨¡å—</h2><p><code>stEventDispatcher</code> ç±»æ˜¯äº‹ä»¶è°ƒåº¦ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè´Ÿè´£ç®¡ç†äº‹ä»¶çš„ç»‘å®šã€æ´¾å‘ä»¥åŠæ¸…ç†ã€‚å®ƒæ”¯æŒèŠ‚ç‚¹ä¹‹é—´çš„äº‹ä»¶ä¼ é€’ï¼Œå¹¶åœ¨èŠ‚ç‚¹é”€æ¯æ—¶è‡ªåŠ¨æ¸…ç†ç›¸å…³äº‹ä»¶ã€‚</p><ul><li><p><strong>æ·»åŠ äº‹ä»¶ç›‘å¬</strong>ï¼š <code>listen(eventName: string, func: EventFunc)</code></p><ul><li>æ³¨å†Œä¸€ä¸ªäº‹ä»¶ç›‘å¬å‡½æ•°ã€‚</li></ul></li><li><p><strong>ç§»é™¤äº‹ä»¶ç›‘å¬</strong>ï¼š<code>removeEventFuncs(eventName: string)</code></p><ul><li>ç§»é™¤æŒ‡å®šäº‹ä»¶çš„æ‰€æœ‰ç›‘å¬å‡½æ•°ã€‚</li></ul></li><li><p><strong>åˆ†å‘äº‹ä»¶</strong>ï¼š <code>dispatch(eventName: string, ...datas)</code></p><ul><li>åˆ†å‘äº‹ä»¶ç»™æ‰€æœ‰æ³¨å†Œçš„ç›‘å¬å‡½æ•°ã€‚</li></ul></li><li><p><strong>ç®¡ç†å­äº‹ä»¶è°ƒåº¦å™¨</strong>ï¼š<br><code>addChild(disp: stEventDispatcher)</code>å’Œ <code>removeChild(disp:stEventDispatcher)</code></p><ul><li>æ·»åŠ å’Œç§»é™¤å­äº‹ä»¶è°ƒåº¦å™¨ï¼Œä»¥æ”¯æŒå¤æ‚çš„äº‹ä»¶ç»“æ„ã€‚</li></ul></li></ul><h2 id="DestroyOb-æ¨¡å—"><a href="#DestroyOb-æ¨¡å—" class="headerlink" title="DestroyOb æ¨¡å—"></a><code>DestroyOb</code> æ¨¡å—</h2><p><code>DestroyOb</code> ç»„ä»¶ç”¨äºç®¡ç† Cocos Creator èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸï¼Œç¡®ä¿åœ¨èŠ‚ç‚¹é”€æ¯æ—¶æ¸…ç†ç›¸å…³èµ„æºå’Œäº‹ä»¶ç›‘å¬å™¨ã€‚</p><ul><li><p><strong>è·å–ç»„ä»¶å®ä¾‹</strong>ï¼š<code>getCom(node: Node): DestroyOb</code></p><ul><li>è·å–æŒ‡å®šèŠ‚ç‚¹ä¸Šçš„ <code>DestroyOb</code> ç»„ä»¶å®ä¾‹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ·»åŠ ä¸€ä¸ªæ–°çš„ã€‚</li></ul></li><li><p><strong>ç›‘å¬é”€æ¯äº‹ä»¶</strong>ï¼š<code>listen(func: Function, node?: Node)</code></p><ul><li>æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œä»¥åœ¨èŠ‚ç‚¹é”€æ¯æ—¶è§¦å‘ã€‚</li></ul></li></ul><h2 id="è·å–æºç "><a href="#è·å–æºç " class="headerlink" title="è·å–æºç "></a>è·å–æºç </h2><p><strong>Datar.ts</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">StData</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./StData&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Node</span> &#125; <span class="keyword">from</span> <span class="string">&quot;cc&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">namespace</span> <span class="title class_">Datar</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">function</span> get&lt;T <span class="keyword">extends</span> keyof <span class="title class_">DatarList</span>&gt;(<span class="attr">key</span>: T): <span class="title class_">DatarList</span>[T] &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">value</span>: <span class="built_in">any</span> = <span class="title class_">StData</span>.<span class="title function_">get</span>(key);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">function</span> set&lt;T <span class="keyword">extends</span> keyof <span class="title class_">DatarList</span>&gt;(<span class="attr">key</span>: T, <span class="attr">value</span>: <span class="title class_">DatarList</span>[T]): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="title class_">StData</span>.<span class="title function_">set</span>(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">function</span> listen&lt;T <span class="keyword">extends</span> keyof <span class="title class_">DatarList</span>&gt;(<span class="attr">key</span>: T, <span class="attr">node</span>: <span class="title class_">Node</span>, <span class="attr">call</span>: <span class="function">(<span class="params">value: DatarList[T]</span>) =&gt;</span> <span class="built_in">void</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="title class_">StData</span>.<span class="title function_">listen</span>(key, node, call);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">function</span> listenget&lt;T <span class="keyword">extends</span> keyof <span class="title class_">DatarList</span>&gt;(<span class="attr">key</span>: T, <span class="attr">dv</span>: <span class="built_in">any</span>, <span class="attr">node</span>: <span class="title class_">Node</span>, <span class="attr">call</span>: <span class="function">(<span class="params">value: DatarList[T]</span>) =&gt;</span> <span class="built_in">void</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="title class_">StData</span>.<span class="title function_">listenget</span>(key, dv, node, call);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">function</span> unlisten&lt;T <span class="keyword">extends</span> keyof <span class="title class_">DatarList</span>&gt;(<span class="attr">key</span>: T, <span class="attr">node</span>: <span class="title class_">Node</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="title class_">StData</span>.<span class="title function_">unlisten</span>(key, node);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">unlistenall</span>(<span class="params">node: Node</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="title class_">StData</span>.<span class="title function_">unlistenall</span>(node);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">DatarList</span> = &#123;</span><br><span class="line">    <span class="string">&quot;game/selectroom&quot;</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>StData.ts</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; stEventDispatcher &#125; <span class="keyword">from</span> <span class="string">&quot;./StEventDispatcher&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">cache</span>: <span class="built_in">any</span> = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> datadisp = <span class="keyword">new</span> stEventDispatcher</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">tostring</span>(<span class="params">v</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> v.<span class="title function_">toString</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">tonumber</span>(<span class="params">v</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Number</span>.<span class="built_in">parseInt</span>(v)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isnumber</span>(<span class="params">v</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> !<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="title function_">tonumber</span>(v))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">namespace</span> <span class="title class_">StData</span> &#123;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">path: <span class="built_in">string</span>, dv?: <span class="built_in">any</span></span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (path == <span class="literal">null</span>) &#123; <span class="keyword">return</span> <span class="literal">null</span> &#125;</span><br><span class="line"><span class="keyword">let</span> paths = path.<span class="title function_">split</span>(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> cur = cache</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> prev</span><br><span class="line"><span class="keyword">let</span> len = paths.<span class="property">length</span></span><br><span class="line"><span class="keyword">let</span> name = <span class="literal">null</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">name = paths[i]</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> (cur) != <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> isArr = <span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">isnumber</span>(name)) &#123;</span><br><span class="line">name = <span class="title function_">tonumber</span>(name)</span><br><span class="line"></span><br><span class="line">isArr = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">prev = cur</span><br><span class="line">cur = cur[name]</span><br><span class="line"><span class="keyword">if</span> (cur == <span class="literal">null</span> &amp;&amp; i &lt; len - <span class="number">1</span> &amp;&amp; len &gt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (isArr) &#123;</span><br><span class="line">cur = []</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">cur = &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">prev[name] = cur</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (cur == <span class="literal">null</span>) &#123;</span><br><span class="line">prev[name] = dv</span><br><span class="line">cur = dv</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (cur != <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> (cur) == <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">cur[<span class="string">&quot;__path__&quot;</span>] = path</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> cur</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> set&lt;T&gt;(<span class="attr">path</span>: <span class="built_in">string</span>, <span class="attr">v</span>: T, ignoreEvent?: <span class="built_in">boolean</span>): T &#123;</span><br><span class="line"><span class="keyword">if</span> (path == <span class="literal">null</span>) &#123; <span class="keyword">return</span> <span class="literal">null</span> &#125;</span><br><span class="line"><span class="keyword">let</span> paths = path.<span class="title function_">split</span>(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> cur = cache</span><br><span class="line"><span class="keyword">let</span> prev</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; paths.<span class="property">length</span> - <span class="number">1</span>; i++) &#123;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">name</span>: <span class="built_in">any</span> = paths[i]</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> (cur) != <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">isnumber</span>(name)) &#123;</span><br><span class="line">name = <span class="title function_">tonumber</span>(name)</span><br><span class="line">&#125;</span><br><span class="line">prev = cur</span><br><span class="line">cur = cur[name]</span><br><span class="line"><span class="keyword">if</span> (cur == <span class="literal">null</span>) &#123;</span><br><span class="line">cur = &#123;&#125;</span><br><span class="line">prev[name] = cur</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> last = paths[paths.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> (cur) != <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line">cur[last] = v</span><br><span class="line"><span class="keyword">if</span> (!ignoreEvent) &#123;</span><br><span class="line">datadisp.<span class="title function_">dispatch</span>(path, v)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">change</span>(<span class="params">input: <span class="built_in">string</span> | <span class="built_in">any</span>, dv?: <span class="built_in">any</span></span>) &#123;</span><br><span class="line"><span class="keyword">let</span> path = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> (input) == <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">path = input</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> (input) != <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">path = input[<span class="string">&quot;__path__&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> value = <span class="title function_">get</span>(path, dv)</span><br><span class="line">datadisp.<span class="title function_">dispatch</span>(path, value)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">clear</span>(<span class="params"></span>) &#123;</span><br><span class="line">cache = &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">listen</span>(<span class="params">path, node, func</span>) &#123;</span><br><span class="line">datadisp.<span class="title function_">addNode</span>(node, <span class="string">&quot;__datadisp&quot;</span>).<span class="title function_">listen</span>(path, func)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">unlisten</span>(<span class="params">path, node</span>) &#123;</span><br><span class="line"><span class="keyword">let</span> disp = datadisp.<span class="title function_">getDisp</span>(node, <span class="string">&quot;__datadisp&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> (disp) &#123;</span><br><span class="line">disp.<span class="title function_">removeEventFuncs</span>(path)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">unlistenall</span>(<span class="params">node</span>) &#123;</span><br><span class="line"><span class="keyword">let</span> disp = datadisp.<span class="title function_">getDisp</span>(node, <span class="string">&quot;__datadisp&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> (disp) &#123;</span><br><span class="line">disp.<span class="title function_">removeAll</span>()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">listenget</span>(<span class="params">path, dv, node, func</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (func == <span class="literal">null</span>) &#123;</span><br><span class="line">func = node</span><br><span class="line">node = dv</span><br><span class="line">dv = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line">datadisp.<span class="title function_">addNode</span>(node, <span class="string">&quot;__datadisp&quot;</span>).<span class="title function_">listen</span>(path, func)</span><br><span class="line"><span class="keyword">let</span> value = <span class="title function_">get</span>(path, dv)</span><br><span class="line"><span class="title function_">func</span>(value)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">listencallget</span>(<span class="params">path, node, func, getfunc</span>) &#123;</span><br><span class="line">datadisp.<span class="title function_">addNode</span>(node, <span class="string">&quot;__datadisp&quot;</span>).<span class="title function_">listen</span>(path, func)</span><br><span class="line"><span class="keyword">let</span> value = <span class="title function_">get</span>(path, <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="title function_">getfunc</span>()</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="title function_">func</span>(value)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getDisp</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">return</span> datadisp</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>StEventDispatcher.ts</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">StDestroy</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./DestroyOb&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; _decorator, <span class="title class_">Component</span>, <span class="title class_">Node</span> &#125; <span class="keyword">from</span> <span class="string">&quot;cc&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">EventFunc</span> = <span class="function">(<span class="params">...datas</span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> funcInfo = &#123;</span><br><span class="line"><span class="attr">func</span>: <span class="title class_">EventFunc</span>,</span><br><span class="line"><span class="attr">enabled</span>: <span class="built_in">boolean</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> childInfo = &#123;</span><br><span class="line"><span class="attr">child</span>: stEventDispatcher,</span><br><span class="line"><span class="attr">enabled</span>: <span class="built_in">boolean</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventComponent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line"><span class="keyword">private</span> <span class="attr">disps_</span>: stEventDispatcher[] = []</span><br><span class="line"><span class="title function_">addDisp</span>(<span class="params">disp: stEventDispatcher</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">disps_</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">v</span>) =&gt;</span> v == disp) == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">disps_</span>.<span class="title function_">push</span>(disp)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">onDestroy</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> disp <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">disps_</span>) &#123;</span><br><span class="line">disp.<span class="title function_">removeFromParent</span>()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> sID = <span class="number">0</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">stEventDispatcher</span> &#123;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">bind</span>(<span class="params">node: Node, name: <span class="built_in">string</span></span>) &#123;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">disp</span>: stEventDispatcher = node[name]</span><br><span class="line"><span class="keyword">if</span> (disp == <span class="literal">null</span>) &#123;</span><br><span class="line">disp = <span class="keyword">new</span> stEventDispatcher</span><br><span class="line">disp.<span class="title function_">link</span>(node)</span><br><span class="line">node[name] = disp</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> disp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">// director.getScheduler().scheduleUpdate(this,-1,false)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> funcs_ = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, funcInfo[]&gt;()</span><br><span class="line"><span class="keyword">private</span> <span class="attr">childs_</span>: childInfo[] = []</span><br><span class="line"><span class="keyword">private</span> <span class="attr">parent_</span>: stEventDispatcher</span><br><span class="line"><span class="keyword">get</span> <span class="title function_">parent</span>() &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">parent_</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> sid_ = sID++</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="attr">node_</span>: <span class="title class_">Node</span></span><br><span class="line"><span class="title function_">link</span>(<span class="params">node: Node</span>) &#123;</span><br><span class="line"><span class="keyword">let</span> self = <span class="variable language_">this</span></span><br><span class="line"><span class="title class_">StDestroy</span>(node, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">self.<span class="title function_">clear</span>()</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">node_</span> = node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">listen</span>(<span class="params">eventName: <span class="built_in">string</span>, func: EventFunc</span>) &#123;</span><br><span class="line"><span class="keyword">let</span> infos = <span class="variable language_">this</span>.<span class="property">funcs_</span>.<span class="title function_">get</span>(eventName)</span><br><span class="line"><span class="keyword">if</span> (infos == <span class="literal">null</span>) &#123;</span><br><span class="line">infos = []</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">funcs_</span>.<span class="title function_">set</span>(eventName, infos)</span><br><span class="line">&#125;</span><br><span class="line">infos.<span class="title function_">push</span>(&#123;</span><br><span class="line"><span class="attr">func</span>: func,</span><br><span class="line"><span class="attr">enabled</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">removeEventFuncs</span>(<span class="params">eventName: <span class="built_in">string</span></span>) &#123;</span><br><span class="line"><span class="keyword">let</span> infos = <span class="variable language_">this</span>.<span class="property">funcs_</span>.<span class="title function_">get</span>(eventName)</span><br><span class="line"><span class="keyword">if</span> (infos) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> info <span class="keyword">of</span> infos) &#123;</span><br><span class="line">info.<span class="property">enabled</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">refresh</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">removeFunc</span>(<span class="params">func: EventFunc</span>) &#123;</span><br><span class="line"><span class="keyword">let</span> self = <span class="variable language_">this</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">funcs_</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">infos, eventName</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> info <span class="keyword">of</span> infos) &#123;</span><br><span class="line"><span class="keyword">if</span> (info.<span class="property">func</span> == func) &#123;</span><br><span class="line">info.<span class="property">enabled</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">refresh</span>()</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">addNode</span>(<span class="params">node: Node, dispName?: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">dispName = dispName || <span class="string">&quot;_default_child_disp_&quot;</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">disp</span>: stEventDispatcher = node[dispName]</span><br><span class="line"><span class="keyword">if</span> (disp) &#123;</span><br><span class="line"><span class="keyword">return</span> disp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">disp = <span class="keyword">new</span> <span class="title function_">stEventDispatcher</span>()</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">addChild</span>(disp)</span><br><span class="line">node[dispName] = disp</span><br><span class="line"></span><br><span class="line">disp.<span class="title function_">link</span>(node)</span><br><span class="line"><span class="keyword">return</span> disp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">getDisp</span>(<span class="params">node: Node, dispName?: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">dispName = dispName || <span class="string">&quot;_default_child_disp_&quot;</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">disp</span>: stEventDispatcher = node[dispName]</span><br><span class="line"><span class="keyword">return</span> disp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">addChild</span>(<span class="params">disp: stEventDispatcher</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (disp.<span class="property">parent_</span> != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> childInfo = <span class="variable language_">this</span>.<span class="property">childs_</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">v</span>) =&gt;</span> v.<span class="property">child</span> == disp)</span><br><span class="line"><span class="keyword">if</span> (childInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">childInfo = &#123;</span><br><span class="line"><span class="attr">child</span>: disp,</span><br><span class="line"><span class="attr">enabled</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">childs_</span>.<span class="title function_">push</span>(childInfo)</span><br><span class="line">&#125;</span><br><span class="line">childInfo.<span class="property">enabled</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">disp.<span class="property">parent_</span> = <span class="variable language_">this</span></span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">removeChild</span>(<span class="params">disp: stEventDispatcher</span>) &#123;</span><br><span class="line"><span class="keyword">let</span> info = <span class="variable language_">this</span>.<span class="property">childs_</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">v</span>) =&gt;</span> v.<span class="property">child</span> == disp)</span><br><span class="line"><span class="keyword">if</span> (info) &#123;</span><br><span class="line">info.<span class="property">enabled</span> = <span class="literal">false</span></span><br><span class="line">info.<span class="property">child</span>.<span class="property">parent_</span> = <span class="literal">null</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">refresh</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">removeAllChildren</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> child <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">childs_</span>) &#123;</span><br><span class="line">child.<span class="property">enabled</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">refresh</span>()</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">removeFromParent</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">parent_</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">parent_</span>.<span class="title function_">removeChild</span>(<span class="variable language_">this</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">removeAll</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> child <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">childs_</span>) &#123;</span><br><span class="line">child.<span class="property">enabled</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">funcs_</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">infos, eventName</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> info <span class="keyword">of</span> infos) &#123;</span><br><span class="line">info.<span class="property">enabled</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">refresh</span>()</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">clear</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">removeFromParent</span>()</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">removeAll</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> isDispatching_ = <span class="literal">false</span></span><br><span class="line"><span class="title function_">dispatch</span>(<span class="params">eventName: <span class="built_in">string</span>, ...datas</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">isDispatching_</span> = <span class="literal">true</span></span><br><span class="line"><span class="keyword">let</span> tempChilds = <span class="variable language_">this</span>.<span class="property">childs_</span>.<span class="title function_">slice</span>()</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> info <span class="keyword">of</span> tempChilds) &#123;</span><br><span class="line"><span class="keyword">if</span> (info.<span class="property">enabled</span>) &#123;</span><br><span class="line"><span class="comment">//EventDispatcher.prototype.dispatch.apply(child.child,datas)</span></span><br><span class="line">info.<span class="property">child</span>.<span class="title function_">dispatch</span>(eventName, ...datas)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> self = <span class="variable language_">this</span></span><br><span class="line"><span class="keyword">let</span> infos = <span class="variable language_">this</span>.<span class="property">funcs_</span>.<span class="title function_">get</span>(eventName)</span><br><span class="line"><span class="keyword">if</span> (infos) &#123;</span><br><span class="line"><span class="keyword">let</span> tempInfos = infos.<span class="title function_">slice</span>()</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> info <span class="keyword">of</span> tempInfos) &#123;</span><br><span class="line"><span class="keyword">if</span> (info.<span class="property">enabled</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//info.func.apply(null,datas)</span></span><br><span class="line">info.<span class="title function_">func</span>(...datas)</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">isDispatching_</span> = <span class="literal">false</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">refresh</span>()</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> isDirty_ = <span class="literal">false</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">refresh</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isDispatching_</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">isDirty_</span> = <span class="literal">true</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isDirty_</span> == <span class="literal">false</span>) &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">isDirty_</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> len = <span class="number">0</span></span><br><span class="line">len = <span class="variable language_">this</span>.<span class="property">childs_</span>.<span class="property">length</span></span><br><span class="line"><span class="keyword">let</span> count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = len - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line"><span class="keyword">let</span> child = <span class="variable language_">this</span>.<span class="property">childs_</span>[i]</span><br><span class="line"><span class="keyword">if</span> (child.<span class="property">enabled</span> == <span class="literal">false</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">childs_</span>.<span class="title function_">splice</span>(i, <span class="number">1</span>)</span><br><span class="line">count++</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> self = <span class="variable language_">this</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">funcs_</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">infos, eventName</span>) &#123;</span><br><span class="line"><span class="keyword">let</span> len = infos.<span class="property">length</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = len - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line"><span class="keyword">let</span> info = infos[i]</span><br><span class="line"><span class="keyword">if</span> (info.<span class="property">enabled</span> == <span class="literal">false</span>) &#123;</span><br><span class="line">infos.<span class="title function_">splice</span>(i, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>DestroyOb.ts</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; stEventDispatcher &#125; <span class="keyword">from</span> <span class="string">&quot;./StEventDispatcher&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; _decorator, <span class="title class_">Component</span>, <span class="title class_">Node</span> &#125; <span class="keyword">from</span> <span class="string">&quot;cc&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> &#123; ccclass, property &#125; = _decorator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> eventName = <span class="string">&quot;_onDestroy_&quot;</span></span><br><span class="line"><span class="meta">@ccclass</span>(<span class="string">&#x27;DestroyOb&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DestroyOb</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">getCom</span>(<span class="attr">node</span>: <span class="title class_">Node</span>): <span class="title class_">DestroyOb</span> &#123;</span><br><span class="line"><span class="keyword">let</span> com = node.<span class="title function_">getComponent</span>(<span class="title class_">DestroyOb</span>)</span><br><span class="line"><span class="keyword">if</span> (com == <span class="literal">null</span>) &#123;</span><br><span class="line">com = node.<span class="title function_">addComponent</span>(<span class="title class_">DestroyOb</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> com</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> disp_ = <span class="keyword">new</span> stEventDispatcher</span><br><span class="line"><span class="title function_">listen</span>(<span class="params">func: <span class="built_in">Function</span>, node?: Node</span>) &#123;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">disp</span>: stEventDispatcher</span><br><span class="line"><span class="keyword">if</span> (node) &#123;</span><br><span class="line">disp = <span class="variable language_">this</span>.<span class="property">disp_</span>.<span class="title function_">addNode</span>(node, <span class="string">&quot;__destroy_ob__&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">disp = <span class="variable language_">this</span>.<span class="property">disp_</span></span><br><span class="line">&#125;</span><br><span class="line">disp.<span class="title function_">listen</span>(eventName, <span class="keyword">function</span> (<span class="params">...params</span>) &#123;</span><br><span class="line"><span class="title function_">func</span>(...params)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">onDestroy</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">disp_</span>.<span class="title function_">dispatch</span>(eventName)</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">disp_</span>.<span class="title function_">clear</span>()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">StDestroy</span>(<span class="params">node: Node, func: <span class="built_in">Function</span>, targetNode?: Node</span>) &#123;</span><br><span class="line">node.<span class="property">active</span> = <span class="literal">true</span></span><br><span class="line"><span class="title class_">DestroyOb</span>.<span class="title function_">getCom</span>(node).<span class="title function_">listen</span>(func, targetNode)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> cocos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®°å½•ä¸€ä¸‹é˜²ç«å¢™firewallçš„ä½¿ç”¨æ–¹æ³•</title>
      <link href="/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8B%E9%98%B2%E7%81%AB%E5%A2%99firewall%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/"/>
      <url>/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8B%E9%98%B2%E7%81%AB%E5%A2%99firewall%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="é˜²ç«å¢™çš„å¼€å¯ã€å…³é—­ã€ç¦ç”¨å‘½ä»¤"><a href="#é˜²ç«å¢™çš„å¼€å¯ã€å…³é—­ã€ç¦ç”¨å‘½ä»¤" class="headerlink" title="é˜²ç«å¢™çš„å¼€å¯ã€å…³é—­ã€ç¦ç”¨å‘½ä»¤"></a>é˜²ç«å¢™çš„å¼€å¯ã€å…³é—­ã€ç¦ç”¨å‘½ä»¤</h2><ul><li><p>è®¾ç½®å¼€æœºå¯ç”¨é˜²ç«å¢™</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable firewalld.service</span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®å¼€æœºç¦ç”¨é˜²ç«å¢™</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable firewalld.service</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨é˜²ç«å¢™</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start firewalld</span><br></pre></td></tr></table></figure></li><li><p>å…³é—­é˜²ç«å¢™</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status firewalld</span><br></pre></td></tr></table></figure></li></ul><h2 id="æŸ¥çœ‹é˜²ç«å¢™è§„åˆ™"><a href="#æŸ¥çœ‹é˜²ç«å¢™è§„åˆ™" class="headerlink" title="æŸ¥çœ‹é˜²ç«å¢™è§„åˆ™"></a>æŸ¥çœ‹é˜²ç«å¢™è§„åˆ™</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --list-all</span><br></pre></td></tr></table></figure><h2 id="æŸ¥è¯¢ç«¯å£æ˜¯å¦å¼€æ”¾"><a href="#æŸ¥è¯¢ç«¯å£æ˜¯å¦å¼€æ”¾" class="headerlink" title="æŸ¥è¯¢ç«¯å£æ˜¯å¦å¼€æ”¾"></a>æŸ¥è¯¢ç«¯å£æ˜¯å¦å¼€æ”¾</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --query-port=8080/tcp</span><br></pre></td></tr></table></figure><h2 id="å¼€æ”¾ç«¯å£"><a href="#å¼€æ”¾ç«¯å£" class="headerlink" title="å¼€æ”¾ç«¯å£"></a>å¼€æ”¾ç«¯å£</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --add-port=80/tcp</span><br></pre></td></tr></table></figure><h2 id="ç§»é™¤ç«¯å£"><a href="#ç§»é™¤ç«¯å£" class="headerlink" title="ç§»é™¤ç«¯å£"></a>ç§»é™¤ç«¯å£</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --remove-port=8080/tcp</span><br></pre></td></tr></table></figure><h2 id="é‡å¯é˜²ç«å¢™-ä¿®æ”¹é…ç½®åè¦é‡å¯é˜²ç«å¢™"><a href="#é‡å¯é˜²ç«å¢™-ä¿®æ”¹é…ç½®åè¦é‡å¯é˜²ç«å¢™" class="headerlink" title="é‡å¯é˜²ç«å¢™(ä¿®æ”¹é…ç½®åè¦é‡å¯é˜²ç«å¢™)"></a>é‡å¯é˜²ç«å¢™(ä¿®æ”¹é…ç½®åè¦é‡å¯é˜²ç«å¢™)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å°äº”ä¸€æ¥äº†</title>
      <link href="/%E5%B0%8F%E4%BA%94%E4%B8%80%E6%9D%A5%E4%BA%86/"/>
      <url>/%E5%B0%8F%E4%BA%94%E4%B8%80%E6%9D%A5%E4%BA%86/</url>
      
        <content type="html"><![CDATA[<p>2024å¹´5æœˆ1æ—¥18æ—¶52åˆ†ï¼Œä½ æ¥åˆ°è¿™ä¸ªä¸–ç•Œï¼Œå¸¦ç€æ— å°½çš„å¸Œæœ›ä¸å–œæ‚¦ã€‚é‚£ä¸€åˆ»ï¼Œæ—¶é—´ä»¿ä½›åœæ»ï¼Œæ•´ä¸ªä¸–ç•Œå› ä½ çš„åˆ°æ¥è€Œå˜å¾—æ›´åŠ å…‰è¾‰ç¿çƒ‚ã€‚</p><p>ä½ çš„å°æ‰‹ç´§æ¡ç€ï¼Œä¼¼ä¹åœ¨å‘æˆ‘ä»¬å±•ç¤ºä½ å¯¹è¿™ä¸ªæ–°ä¸–ç•Œçš„æ¸´æœ›ä¸å¥½å¥‡ã€‚ä½ çš„å°è„¸ä¸Šæ´‹æº¢ç€çº¯çœŸçš„ç¬‘å®¹ï¼Œè®©æˆ‘ä»¬æ„Ÿå—åˆ°æ— å°½çš„å¹¸ç¦ã€‚æˆ‘ä»¬æ·±çŸ¥ï¼Œä½ çš„æœªæ¥å……æ»¡äº†æ— é™å¯èƒ½ï¼Œè€Œæˆ‘ä»¬å°†å°½å…¨åŠ›ä¸ºä½ åˆ›é€ ä¸€ä¸ªæ¸©æš–ã€å……æ»¡çˆ±çš„å®¶ã€‚</p><p>çœ‹ç€ä½ å®‰è¯¦åœ°èººåœ¨æ€€é‡Œï¼Œæˆ‘ä»¬å¿ƒä¸­æ»¡æ˜¯æ„Ÿæ©ä¸æ¿€åŠ¨ã€‚ä»ä»Šå¤©èµ·ï¼Œæˆ‘ä»¬çš„ç”Ÿå‘½å°†å› ä½ è€Œå˜å¾—æ›´åŠ å®Œæ•´å’Œä¸°å¯Œã€‚ä½ çš„æ¯ä¸€æ¬¡å¾®ç¬‘ã€æ¯ä¸€ä¸ªæˆé•¿çš„ç¬é—´ï¼Œéƒ½ä¼šæˆä¸ºæˆ‘ä»¬æœ€çè´µçš„è®°å¿†ã€‚</p><p>æœªæ¥çš„æ—¥å­é‡Œï¼Œæˆ‘ä»¬å°†é™ªä¼´ä½ ä¸€èµ·ç»å†é£é›¨ï¼Œä¸€èµ·è¿æ¥é˜³å…‰ã€‚æ— è®ºå‰æ–¹çš„é“è·¯å¤šä¹ˆæ›²æŠ˜ï¼Œæˆ‘ä»¬éƒ½ä¼šåœ¨ä½ èº«è¾¹ï¼Œç»™äºˆä½ æ— æ¡ä»¶çš„çˆ±ä¸æ”¯æŒã€‚æˆ‘ä»¬å¸Œæœ›ï¼Œä½ èƒ½å¤Ÿå‹‡æ•¢è¿½æ¢¦ï¼Œæ¢ç´¢è¿™ä¸ªä¸–ç•Œçš„ç¾å¥½ï¼Œæˆä¸ºæœ€å¥½çš„è‡ªå·±ã€‚</p><p>æ¬¢è¿ä½ ï¼Œäº²çˆ±çš„å­©å­ã€‚ä½ çš„åˆ°æ¥ï¼Œè®©æˆ‘ä»¬æ·±åˆ»ä½“ä¼šåˆ°ç”Ÿå‘½çš„å¥‡è¿¹å’Œçˆ±çš„ä¼Ÿå¤§ã€‚ä»æ­¤ï¼Œæˆ‘ä»¬çš„äººç”Ÿå°†å› ä½ è€Œæ›´åŠ å¤šå½©ï¼Œè€Œä½ ï¼Œå°†æ°¸è¿œæ˜¯æˆ‘ä»¬å¿ƒä¸­æœ€é—ªè€€çš„æ˜Ÿæ˜Ÿã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/haix8/images/IMG_0814.jpeg"></p>]]></content>
      
      
      
        <tags>
            
            <tag> éšç¬” </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¾®ä¿¡è®¢é˜…å·å®šæ—¶å‘é€æ¶ˆæ¯çš„å·¥å…·</title>
      <link href="/%E5%BE%AE%E4%BF%A1%E8%AE%A2%E9%98%85%E5%8F%B7%E5%AE%9A%E6%97%B6%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E7%9A%84%E5%B7%A5%E5%85%B7/"/>
      <url>/%E5%BE%AE%E4%BF%A1%E8%AE%A2%E9%98%85%E5%8F%B7%E5%AE%9A%E6%97%B6%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E7%9A%84%E5%B7%A5%E5%85%B7/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸ºä»€ä¹ˆåš"><a href="#ä¸ºä»€ä¹ˆåš" class="headerlink" title="ä¸ºä»€ä¹ˆåš"></a>ä¸ºä»€ä¹ˆåš</h2><p>ä¹‹å‰åœ¨æ˜é‡‘ä¸Šçœ‹åˆ°å¾ˆå¤šäººåˆ†äº«ï¼Œç»™å¥³æœ‹å‹æˆ–â€œä»»ä½•äººâ€æ¯å¤©å®šæ—¶æ¨é€æ¶ˆæ¯ï¼Œåƒæ˜¯çºªå¿µæ—¥æé†’ã€æ¯æ—¥ä¸€å¥å…³å¿ƒè¿™ç±»çš„ã€‚æ„Ÿè§‰æœ‰ç‚¹æ„æ€äºæ˜¯æƒ³ç€ä¹Ÿç»™æˆ‘å®¶é‚£ä½æ•´ä¸ªã€‚</p><h2 id="æ€ä¹ˆåš"><a href="#æ€ä¹ˆåš" class="headerlink" title="æ€ä¹ˆåš"></a>æ€ä¹ˆåš</h2><p>å®ç°æ–¹å¼äº”èŠ±å…«é—¨ï¼Œæˆ‘ä¸ºäº†æ–¹ä¾¿åˆ©ç”¨å¾®ä¿¡æœåŠ¡å·ç»™æ¨é€æ¨¡ç‰ˆä¿¡æ¯,å®šæ—¶ä»»åŠ¡ç”¨äº†laravelçš„ä»»åŠ¡è°ƒåº¦(å…¶å®å°±åªæ˜¯ç”¨å®ƒä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œä¸ç”¨æ¡†æ¶ä¹Ÿå®Œå…¨å¯ä»¥)ã€‚</p><h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><ul><li><input disabled="" type="checkbox"> è°ƒç”¨å¤©è¡Œæ•°æ®çš„apiï¼Œè·å–è‡ªå·±æƒ³è¦çš„æ•°æ®,å°è£…èµ·æ¥</li><li><input disabled="" type="checkbox"> è°ƒç”¨easywechatçš„æ¥å£ï¼Œå®ç°ç»™å¾®ä¿¡å¥½å‹å‘é€æ¶ˆæ¯</li><li><input disabled="" type="checkbox"> æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼Œå®ç°å®šæ—¶å‘é€</li></ul><h2 id="å®ç°æ­¥éª¤"><a href="#å®ç°æ­¥éª¤" class="headerlink" title="å®ç°æ­¥éª¤"></a>å®ç°æ­¥éª¤</h2><ol><li><p>åˆ›å»ºå¾®ä¿¡æ¨¡ç‰ˆæ¶ˆæ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">â¤æ—©å®‰å–â¤</span><br><span class="line">&#123;&#123;date.DATA&#125;&#125;&#123;&#123;remark.DATA&#125;&#125;</span><br><span class="line">æ‰€åœ¨åŸå¸‚ï¼š&#123;&#123;city.DATA&#125;&#125;</span><br><span class="line">ä»Šå¤©å¤©æ°”ï¼š&#123;&#123;weather.DATA&#125;&#125;</span><br><span class="line">æ°”æ¸©å˜åŒ–ï¼š&#123;&#123;minTemperature.DATA&#125;&#125;~&#123;&#123;maxTemperature.DATA&#125;&#125;</span><br><span class="line">ä»Šå¤©å»ºè®®ï¼š&#123;&#123;tips.DATA&#125;&#125;</span><br><span class="line"></span><br><span class="line">ä»Šå¤©æ˜¯æˆ‘ä»¬ç›¸æ‹Deç¬¬&#123;&#123;loveDays.DATA&#125;&#125;å¤©</span><br><span class="line">è·ç¦»å¤§å®å®çš„ç”Ÿæ—¥è¿˜æœ‰&#123;&#123;birthDay.DATA&#125;&#125;å¤©</span><br><span class="line">è·ç¦»å°å®å®çš„ç”Ÿæ—¥è¿˜æœ‰&#123;&#123;childBirthDay.DATA&#125;&#125;å¤©</span><br><span class="line"></span><br><span class="line">&#123;&#123;rainbow.DATA&#125;&#125;</span><br></pre></td></tr></table></figure></li><li><p>è°ƒç”¨å¤©è¡Œæ•°æ®æ¥å£ï¼Œè·å–å¤©æ°”é¢„æŠ¥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">tianqi</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable">$uri</span> = <span class="string">&#x27;https://apis.tianapi.com/tianqi/index&#x27;</span>;</span><br><span class="line">        <span class="variable">$client</span> = <span class="keyword">new</span> <span class="title class_">Client</span>();</span><br><span class="line">        <span class="variable">$response</span> = <span class="variable">$client</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$uri</span>, [</span><br><span class="line">            <span class="string">&#x27;query&#x27;</span> =&gt; [</span><br><span class="line">                <span class="string">&#x27;key&#x27;</span> =&gt; <span class="string">&#x27;key&#x27;</span>,//ä½ è‡ªå·±ç”³è¯·çš„key</span><br><span class="line">                <span class="string">&#x27;city&#x27;</span> =&gt; <span class="string">&#x27;éƒ‘å·&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span> =&gt; <span class="string">&#x27;1&#x27;</span></span><br><span class="line">            ]</span><br><span class="line">        ]);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;t.json&#x27;</span>,<span class="variable">$response</span>-&gt;<span class="title function_ invoke__">getBody</span>()-&gt;<span class="title function_ invoke__">getContents</span>());<span class="keyword">die</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">json_decode</span>(<span class="variable">$response</span>-&gt;<span class="title function_ invoke__">getBody</span>()-&gt;<span class="title function_ invoke__">getContents</span>())-&gt;result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$exception</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        &quot;code&quot;: 200,</span></span><br><span class="line"><span class="comment">        &quot;msg&quot;: &quot;success&quot;,</span></span><br><span class="line"><span class="comment">        &quot;result&quot;: &#123;</span></span><br><span class="line"><span class="comment">            &quot;date&quot;: &quot;2023-12-13&quot;,</span></span><br><span class="line"><span class="comment">            &quot;week&quot;: &quot;æ˜ŸæœŸä¸‰&quot;,</span></span><br><span class="line"><span class="comment">            &quot;province&quot;: &quot;æ²³å—&quot;,</span></span><br><span class="line"><span class="comment">            &quot;area&quot;: &quot;éƒ‘å·&quot;,</span></span><br><span class="line"><span class="comment">            &quot;areaid&quot;: &quot;101180101&quot;,</span></span><br><span class="line"><span class="comment">            &quot;weather&quot;: &quot;é˜´&quot;,</span></span><br><span class="line"><span class="comment">            &quot;weatherimg&quot;: &quot;yin.png&quot;,</span></span><br><span class="line"><span class="comment">            &quot;weathercode&quot;: &quot;yin&quot;,</span></span><br><span class="line"><span class="comment">            &quot;real&quot;: &quot;-0.5â„ƒ&quot;,</span></span><br><span class="line"><span class="comment">            &quot;lowest&quot;: &quot;-1â„ƒ&quot;,</span></span><br><span class="line"><span class="comment">            &quot;highest&quot;: &quot;0â„ƒ&quot;,</span></span><br><span class="line"><span class="comment">            &quot;wind&quot;: &quot;ä¸œåŒ—é£&quot;,</span></span><br><span class="line"><span class="comment">            &quot;windspeed&quot;: &quot;11&quot;,</span></span><br><span class="line"><span class="comment">            &quot;windsc&quot;: &quot;2çº§&quot;,</span></span><br><span class="line"><span class="comment">            &quot;sunrise&quot;: &quot;07:23&quot;,</span></span><br><span class="line"><span class="comment">            &quot;sunset&quot;: &quot;17:15&quot;,</span></span><br><span class="line"><span class="comment">            &quot;moonrise&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">            &quot;moondown&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">            &quot;pcpn&quot;: &quot;0&quot;,</span></span><br><span class="line"><span class="comment">            &quot;uv_index&quot;: &quot;0&quot;,</span></span><br><span class="line"><span class="comment">            &quot;aqi&quot;: &quot;104&quot;,</span></span><br><span class="line"><span class="comment">            &quot;quality&quot;: &quot;è½»åº¦&quot;,</span></span><br><span class="line"><span class="comment">            &quot;vis&quot;: &quot;1&quot;,</span></span><br><span class="line"><span class="comment">            &quot;humidity&quot;: &quot;96&quot;,</span></span><br><span class="line"><span class="comment">            &quot;alarmlist&quot;: [</span></span><br><span class="line"><span class="comment">                &#123;</span></span><br><span class="line"><span class="comment">                &quot;province&quot;: &quot;æ²³å—çœ&quot;,</span></span><br><span class="line"><span class="comment">                &quot;city&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">                &quot;level&quot;: &quot;é»„è‰²&quot;,</span></span><br><span class="line"><span class="comment">                &quot;type&quot;: &quot;é“è·¯ç»“å†°&quot;,</span></span><br><span class="line"><span class="comment">                &quot;content&quot;: &quot;æ²³å—çœæ°”è±¡å°2023å¹´12æœˆ12æ—¥16æ—¶00åˆ†ç»§ç»­å‘å¸ƒé“è·¯ç»“å†°é»„è‰²é¢„è­¦ï¼šé¢„è®¡12æœˆ12æ—¥16æ—¶åˆ°13æ—¥16æ—¶ï¼Œè¥¿éƒ¨ã€åŒ—ä¸­éƒ¨æœ‰é›¨å¤¹é›ªæˆ–ä¸­é›ªï¼Œå±€éƒ¨å¤§é›ªæˆ–æš´é›ªï¼Œéƒ¨åˆ†å¿å¸‚ä¼´æœ‰å†»é›¨ï¼›å…¶ä»–å¿å¸‚æœ‰å°åˆ°ä¸­é›¨ã€‚å…¨çœå¤§éƒ¨å¿å¸‚è·¯è¡¨æ¸©åº¦ä½äº0â„ƒï¼Œå°†å‡ºç°å¯¹äº¤é€šæœ‰è¾ƒå¤§å½±å“çš„é“è·¯ç»“å†°ï¼Œå…¶ä¸­é»„æ²³ä»¥åŒ—åŠä¸‰é—¨å³¡ã€æ´›é˜³ã€éƒ‘å·ã€å¼€å°ã€è®¸æ˜ŒåŒ—éƒ¨ã€å¹³é¡¶å±±åŒ—éƒ¨å½±å“è¾ƒä¸¥é‡ã€‚è¯·æ³¨æ„é˜²èŒƒã€‚\né˜²å¾¡æŒ‡å—ï¼š\n1.äº¤é€šè¿è¾“ã€å…¬å®‰ç­‰éƒ¨é—¨åº”æŒ‰ç…§èŒè´£åšå¥½é“è·¯ç»“å†°åº”å¯¹å‡†å¤‡å·¥ä½œï¼›\n2.é©¾é©¶äººå‘˜åº”å½“æ³¨æ„è·¯å†µï¼Œå®‰å…¨è¡Œé©¶ï¼›\n3.è¡Œäººå‡å°‘å¤–å‡ºï¼Œå¿…è¦å¤–å‡ºæ—¶å°½é‡å°‘éª‘è‡ªè¡Œè½¦ï¼Œæ³¨æ„é˜²æ»‘ã€‚ï¼ˆé¢„è­¦ä¿¡æ¯æ¥æºï¼šå›½å®¶é¢„è­¦ä¿¡æ¯å‘å¸ƒä¸­å¿ƒï¼‰&quot;,</span></span><br><span class="line"><span class="comment">                &quot;time&quot;: &quot;2023-12-12 16:00:00&quot;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            ],</span></span><br><span class="line"><span class="comment">            &quot;tips&quot;: &quot;å¤©æ°”å¯’å†·ï¼Œå†¬å­£ç€è£…ï¼šæ£‰è¡£ã€ç¾½ç»’æœã€å†¬å¤§è¡£ã€çš®å¤¹å…‹åŠ ç¾Šæ¯›è¡«ã€åšå‘¢å¤–å¥—ã€å‘¢å¸½ã€æ‰‹å¥—ç­‰ï¼›å¹´è€ä½“å¼±è€…å°½é‡å°‘å¤–å‡ºã€‚ç©ºæ°”è´¨é‡è¾ƒå·®ï¼Œæ•æ„Ÿäººç¾¤å»ºè®®å‡å°‘ä½“åŠ›æ¶ˆè€—ç±»æˆ·å¤–æ´»åŠ¨ã€‚&quot;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;       </span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç»„åˆæ¨¡ç‰ˆæ¶ˆæ¯</p><p>è®¡ç®—æ‹çˆ±å¤©æ•°</p> <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getLoveDays</span>(<span class="params"></span>): <span class="title">int</span></span>&#123;</span><br><span class="line">    <span class="variable">$start_date</span> = <span class="built_in">self</span>::<span class="variable">$loveDays</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Carbon</span>::<span class="title function_ invoke__">now</span>()-&gt;<span class="title function_ invoke__">diffInDays</span>(<span class="variable">$start_date</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¡ç®—ç”Ÿæ—¥å‰©ä½™å¤©æ•°</p> <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getBirthDays</span>(<span class="params"><span class="variable">$start_date</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$birthday</span> = <span class="title class_">Carbon</span>::<span class="title function_ invoke__">parse</span>(<span class="variable">$start_date</span>);</span><br><span class="line">    <span class="variable">$birthday</span>-&gt;<span class="title function_ invoke__">year</span>(<span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y&#x27;</span>));</span><br><span class="line">    <span class="variable">$d</span> = <span class="title class_">Carbon</span>::<span class="title function_ invoke__">now</span>()-&gt;<span class="title function_ invoke__">diffInDays</span>(<span class="variable">$birthday</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$d</span> &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//è®¡ç®—æ˜å¹´</span></span><br><span class="line">        <span class="variable">$birthday</span>-&gt;<span class="title function_ invoke__">year</span>(<span class="title function_ invoke__">date</span>(<span class="string">&quot;Y&quot;</span>, <span class="title function_ invoke__">strtotime</span>(<span class="string">&quot;+1 year&quot;</span>)));</span><br><span class="line">        <span class="variable">$d</span> = <span class="title class_">Carbon</span>::<span class="title function_ invoke__">now</span>()-&gt;<span class="title function_ invoke__">diffInDays</span>(<span class="variable">$birthday</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$d</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> æ¨¡ç‰ˆæ¶ˆæ¯</p> <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$msg</span> = [</span><br><span class="line">    <span class="string">&#x27;touser&#x27;</span> =&gt; <span class="variable">$touser</span>,</span><br><span class="line">    <span class="string">&#x27;template_id&#x27;</span> =&gt; <span class="string">&#x27;2-grcuQ9CVdf0mMrPjf_6ipXBiCN1t0XyVmhn6GC_YM&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;data&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;date&#x27;</span> =&gt; [</span><br><span class="line">            <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d&#x27;</span>) . <span class="variable">$weather</span>-&gt;week,</span><br><span class="line">            <span class="string">&#x27;#00BFFF&#x27;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="comment">// &quot;â¤&quot;</span></span><br><span class="line">        <span class="string">&#x27;remark&#x27;</span> =&gt; <span class="variable">$remark</span>,</span><br><span class="line">        <span class="string">&#x27;city&#x27;</span> =&gt; [</span><br><span class="line">            <span class="variable">$weather</span>-&gt;area,</span><br><span class="line">            <span class="string">&#x27;&#x27;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;weather&#x27;</span> =&gt; [</span><br><span class="line">            <span class="variable">$weather</span>-&gt;weather,</span><br><span class="line">            <span class="string">&quot;#1f95c5&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;minTemperature&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;value&#x27;</span> =&gt; <span class="variable">$weather</span>-&gt;lowest,</span><br><span class="line">            <span class="string">&#x27;color&#x27;</span> =&gt; <span class="string">&#x27;#0ace3c&#x27;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;maxTemperature&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;value&#x27;</span> =&gt; <span class="variable">$weather</span>-&gt;highest,</span><br><span class="line">            <span class="string">&#x27;color&#x27;</span> =&gt; <span class="string">&#x27;#dc1010&#x27;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;tips&#x27;</span> =&gt; [</span><br><span class="line">            <span class="variable">$weather</span>-&gt;tips,</span><br><span class="line">            <span class="string">&quot;&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;loveDays&#x27;</span> =&gt; [</span><br><span class="line">            <span class="variable">$loveDays</span>,</span><br><span class="line">            <span class="string">&quot;#FFA500&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;birthDay&#x27;</span> =&gt; [</span><br><span class="line">            <span class="variable">$birthDays</span>,</span><br><span class="line">            <span class="string">&quot;#FFA500&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;childBirthDay&#x27;</span> =&gt; [</span><br><span class="line">            <span class="variable">$childBirthDay</span>,</span><br><span class="line">            <span class="string">&quot;#FFA500&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;rainbow&#x27;</span> =&gt; [</span><br><span class="line">            <span class="variable">$rainbow</span>,</span><br><span class="line">            <span class="string">&quot;#FF69B4&quot;</span></span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">];</span><br></pre></td></tr></table></figure></li><li><p>ç»™æŒ‡å®šå¾®ä¿¡å¥½å‹æ¨é€æ¶ˆæ¯</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">EasyWeChat</span>\<span class="title">Factory</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$config</span> = [</span><br><span class="line">    <span class="string">&#x27;app_id&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,<span class="comment">//ä½ è‡ªå·±çš„appID</span></span><br><span class="line">    <span class="string">&#x27;secret&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,<span class="comment">//ä½ è‡ªå·±çš„appsecret</span></span><br><span class="line">    <span class="comment">// æŒ‡å®š API è°ƒç”¨è¿”å›ç»“æœçš„ç±»å‹ï¼šarray(default)/collection/object/raw/è‡ªå®šä¹‰ç±»å</span></span><br><span class="line">    <span class="string">&#x27;response_type&#x27;</span> =&gt; <span class="string">&#x27;array&#x27;</span>,</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">];</span><br><span class="line"><span class="variable language_">$this</span>-&gt;app = <span class="title class_">Factory</span>::<span class="title function_ invoke__">officialAccount</span>(<span class="variable">$config</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$result</span> = <span class="variable language_">$this</span>-&gt;app-&gt;template_message-&gt;<span class="title function_ invoke__">send</span>(<span class="variable">$msg</span>);</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ å®šæ—¶ä»»åŠ¡</p></li></ol><p>Linux crontab</p><p><code>* * * * * cd /ä½ çš„é¡¹ç›®è·¯å¾„ &amp;&amp; php artisan schedule:run &gt;&gt; /dev/null 2&gt;&amp;1</code></p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p><a href="https://github.com/haix8/wechatMessage">å®Œæ•´ä»£ç ç‚¹è¿™é‡Œ</a></p><p>å¾®ä¿¡åœ¨2023å¹´5æœˆå¯¹æ¨¡ç‰ˆæ¶ˆæ¯ä½œå‡ºè°ƒæ•´ï¼ŒæŠŠè‡ªå®šä¹‰é¢œè‰²ã€è¡¨æƒ…ç¬¦å·ã€å¤‡æ³¨å†…å®¹ç­‰ç§»é™¤äº†ï¼Œå…·ä½“å¯è§<a href="https://mp.weixin.qq.com/cgi-bin/announce?action=getannouncement&announce_id=11680142498cInTZ&version=&lang=zh_CN&token=">å…¬å‘Š</a>ï¼Œæ‰€ä»¥ä»¥ä¸Šä»£ç ä¸­çš„è‡ªå®šä¹‰é¢œè‰²ã€remarkéƒ½å·²ä¸ç”Ÿæ•ˆï¼Œä½†æ˜¯ä¹Ÿä¸å½±å“æ­£å¸¸ä½¿ç”¨ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> laravel </tag>
            
            <tag> wechat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é€šè¿‡å°ç¨‹åºUrlSchemeè·³è½¬å°ç¨‹åº</title>
      <link href="/%E9%80%9A%E8%BF%87%E5%B0%8F%E7%A8%8B%E5%BA%8FUrlScheme%E8%B7%B3%E8%BD%AC%E5%B0%8F%E7%A8%8B%E5%BA%8F/"/>
      <url>/%E9%80%9A%E8%BF%87%E5%B0%8F%E7%A8%8B%E5%BA%8FUrlScheme%E8%B7%B3%E8%BD%AC%E5%B0%8F%E7%A8%8B%E5%BA%8F/</url>
      
        <content type="html"><![CDATA[<p>è·å–äº†å°ç¨‹åºçš„schemeç ï¼Œå°±å¯ä»¥åƒæ‰“å¼€ç½‘é¡µé“¾æ¥ä¸€æ ·ï¼Œé€šè¿‡çŸ­ä¿¡ã€é‚®ä»¶ã€å¤–éƒ¨ç½‘é¡µç­‰å¾®ä¿¡ä»¥å¤–çš„æ¸ é“æ‹‰èµ·å°ç¨‹åºï¼ŒURL Schemeé“¾æ¥å½¢å¼å¦‚<code>weixin://dl/business/?t= *TICKET*</code>ã€‚</p><p><strong>è¯ä¸å¤šè¯´ç›´æ¥ä¸Šä»£ç </strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–å°ç¨‹åºUrlScheme</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å°ç¨‹åºçš„Â AppIDå’ŒÂ AppSecret</span></span><br><span class="line"><span class="variable">$appId</span> = <span class="string">&#x27;*********&#x27;</span>;</span><br><span class="line"><span class="variable">$appSecret</span> = <span class="string">&#x27;*********&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$us</span> = <span class="title function_ invoke__">getUrlScheme</span>(<span class="title function_ invoke__">getAccessToken</span>(<span class="variable">$appId</span>, <span class="variable">$appSecret</span>));</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">Header</span>(<span class="string">&quot;Location: <span class="subst">$us</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * curl</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">httpRequest</span>(<span class="params"><span class="variable">$url</span>, <span class="variable">$format</span> = <span class="string">&#x27;get&#x27;</span>, <span class="variable">$data</span> = <span class="literal">null</span>, <span class="variable">$headerArray</span> = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//è®¾ç½®å¤´ä¿¡æ¯</span></span><br><span class="line">    <span class="variable">$curl</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_SSL_VERIFYPEER, <span class="literal">FALSE</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_SSL_VERIFYHOST, <span class="literal">FALSE</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$format</span> == <span class="string">&#x27;post&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">//postä¼ å€¼è®¾ç½®postä¼ å‚</span></span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_POST, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$data</span>) &#123;</span><br><span class="line">            <span class="variable">$data</span> = <span class="title function_ invoke__">json_encode</span>(<span class="variable">$data</span>);</span><br><span class="line">            <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_POSTFIELDS, <span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$headerArray</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_HTTPHEADER, <span class="variable">$headerArray</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$curl</span>), <span class="literal">true</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_close</span>(<span class="variable">$curl</span>);</span><br><span class="line">    <span class="comment">//è¿”å›æ¥å£è¿”å›æ•°æ®</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAccessToken</span>(<span class="params"><span class="variable">$appId</span>, <span class="variable">$appSecret</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$redis</span> = <span class="keyword">new</span> <span class="title class_">Redis</span>();</span><br><span class="line">    <span class="variable">$redis</span>-&gt;<span class="title function_ invoke__">connect</span>(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">6379</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$key</span> = <span class="string">&#x27;rout:accessToke&#x27;</span>;</span><br><span class="line">    <span class="variable">$at</span> = <span class="variable">$redis</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$key</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$at</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$at</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">httpRequest</span>(</span><br><span class="line">        <span class="string">&#x27;https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=&#x27;</span> . <span class="variable">$appId</span> . <span class="string">&#x27;&amp;secret=&#x27;</span> . <span class="variable">$appSecret</span>,</span><br><span class="line">        <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        <span class="keyword">array</span>(<span class="string">&quot;Content-type:application/json;&quot;</span>, <span class="string">&quot;Accept:application/json&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="variable">$at</span> = <span class="variable">$data</span>[<span class="string">&#x27;access_token&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable">$redis</span>-&gt;<span class="title function_ invoke__">set</span>(<span class="string">&#x27;rout:accessToke&#x27;</span>, <span class="variable">$at</span>, <span class="number">60</span> * <span class="number">90</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$at</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUrlScheme</span>(<span class="params"><span class="variable">$accessToken</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">httpRequest</span>(</span><br><span class="line">        <span class="string">&#x27;https://api.weixin.qq.com/wxa/generatescheme?access_token=&#x27;</span> . <span class="variable">$accessToken</span>,</span><br><span class="line">        <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">        [</span><br><span class="line">            <span class="string">&#x27;jump_wxa&#x27;</span> =&gt; [</span><br><span class="line">                <span class="string">&#x27;path&#x27;</span> =&gt; <span class="string">&quot;/pages/index/index&quot;</span>,//è·³è½¬å°ç¨‹åºåœ°å€</span><br><span class="line">                <span class="string">&#x27;query&#x27;</span> =&gt; <span class="string">&quot;&quot;</span>//è·³è½¬å°ç¨‹åºé¢å¤–å‚æ•°</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&#x27;expire_type&#x27;</span> =&gt; <span class="number">0</span></span><br><span class="line">        ]</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>[<span class="string">&#x27;openlink&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> å¾®ä¿¡å°ç¨‹åº </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UniAppæ¥å…¥ApplePay</title>
      <link href="/UniApp%E6%8E%A5%E5%85%A5ApplePay/"/>
      <url>/UniApp%E6%8E%A5%E5%85%A5ApplePay/</url>
      
        <content type="html"><![CDATA[<p><img src="/images/applepay.png" alt="applepay.webp"></p><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>æœ€è¿‘ä¸€ä¸ªappé¡¹ç›®ä¸­éœ€è¦å¯¹æ¥Apple Payå†…è´­ï¼Œå› ä¸ºä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡å¯¹æ¥ï¼Œæ‰€ä»¥è®°å½•ä¸‹è¿‡ç¨‹ã€‚</p><h2 id="ä¸Šä¼ åº”ç”¨ç‰ˆæœ¬"><a href="#ä¸Šä¼ åº”ç”¨ç‰ˆæœ¬" class="headerlink" title="ä¸Šä¼ åº”ç”¨ç‰ˆæœ¬"></a>ä¸Šä¼ åº”ç”¨ç‰ˆæœ¬</h2><ul><li>åœ¨<a href="https://appstoreconnect.apple.com/">App Store Connect</a>ä¸­ä¸Šä¼ ä¸€ä¸ªåº”ç”¨ç‰ˆæœ¬ã€‚æœ‰ç‰ˆæœ¬å³å¯ã€‚</li></ul><h2 id="æ·»åŠ å†…è´­é¡¹ç›®ã€‚"><a href="#æ·»åŠ å†…è´­é¡¹ç›®ã€‚" class="headerlink" title="æ·»åŠ å†…è´­é¡¹ç›®ã€‚"></a>æ·»åŠ å†…è´­é¡¹ç›®ã€‚</h2><ul><li>è·Ÿç€è¡¨å•æäº¤å³å¯ã€‚</li><li>æ³¨æ„ä¸Šä¼ å®¡æ ¸ä¿¡æ¯æˆªå±å’Œå¤‡æ³¨ï¼Œæäº¤å®Œåå½“çŠ¶æ€ä¸ºå‡†å¤‡æäº¤å³å¯ã€‚</li><li>äº§å“IDæ˜¯å”¯ä¸€å­—æ¯æ•°å­—IDã€‚ä¸€æ—¦è¯¥IDæ·»åŠ è¿‡ï¼Œå³ä½¿åˆ é™¤è¯¥äº§å“ï¼Œæ­¤IDä¹Ÿæ— æ³•å†æ¬¡ä½¿ç”¨ã€‚<br><img src="/images/k3u1fbpfcp.png" alt="image.png"><br><img src="/images/7b0083e1.png" alt="image.png"></li><li>åœ¨ç‰ˆæœ¬ä¸­å‹¾é€‰ä¸Šé¢æ·»åŠ å¥½çš„å†…è´­é¡¹ç›®<br><img src="/images/4fbab146a1.png" alt="image.png"></li></ul><h2 id="å®Œå–„åè®®-ç¨åŠ¡"><a href="#å®Œå–„åè®®-ç¨åŠ¡" class="headerlink" title="å®Œå–„åè®®&#x2F;ç¨åŠ¡"></a>å®Œå–„åè®®&#x2F;ç¨åŠ¡</h2><p><img src="/images/195f626e.png" alt="image.png"></p><ul><li>â€œå…è´¹appâ€é»˜è®¤çš„æœ‰æ•ˆæœŸï¼Œæ˜¯å’Œè´¦å·çš„åˆ°æœŸæ—¶é—´ä¿æŒä¸€è‡´çš„ï¼Œè€Œâ€œä»˜è´¹åº”ç”¨ç¨‹åºâ€åˆ™éœ€è¦è¿›è¡Œè¿›ä¸€æ­¥è®¾ç½®ï¼Œç‚¹å‡»å³ä¾§â€œæŸ¥çœ‹å¹¶åŒæ„æ¡æ¬¾â€ã€‚</li><li>å¡«å†™åœ°å€ä¿¡æ¯ï¼Œåœ°å€å¿…é¡»æ˜¯è‹±æ–‡&#x2F;æ‹¼éŸ³ï¼Œå¦‚æœåœ°å€å¤ªé•¿å¯ä»¥åˆ†2è¡Œå¡«å†™ã€‚</li><li>å®Œå–„é“¶è¡Œå¡ç­‰ä¿¡æ¯ï¼ŒæŒå¡äººå§“åå¿…é¡»æ˜¯è‹±æ–‡&#x2F;æ‹¼éŸ³ã€‚å¦‚æœé“¶è¡Œæ”¶æ¬¾ä¿¡æ¯ä¸æ¸…æ¥šå¯ä»¥å‘é“¶è¡Œè‡´ç”µæŸ¥è¯¢ã€‚</li><li>è®¾ç½®ã€ç¨åŠ¡åè®®ï¼Œç¾å›½ç¨åŠ¡åè®®ã€‘ï¼Œ<a href="https://zhuanlan.zhihu.com/p/64728939">è¯¦ç»†æµç¨‹ç‚¹è¿™é‡Œ</a>ã€‚</li><li>å®¡æ ¸é€šè¿‡ä¹‹åçŠ¶æ€ä¸ºæœ‰æ•ˆå³å¯è¿›è¡Œä¸‹ä¸€æ­¥<br><img src="/images/0d945672.png" alt="image.png"></li></ul><h2 id="è¯ä¹¦é…ç½®"><a href="#è¯ä¹¦é…ç½®" class="headerlink" title="è¯ä¹¦é…ç½®"></a>è¯ä¹¦é…ç½®</h2><ul><li>è¯ä¹¦éœ€è¦å‹¾é€‰ï¼Œé…ç½®ä¸€ä¸ªmerchantã€‚</li></ul><p><img src="/images/cf6ffd90d0.png" alt="image.png"></p><h2 id="ä»£ç å¯¹æ¥"><a href="#ä»£ç å¯¹æ¥" class="headerlink" title="ä»£ç å¯¹æ¥"></a>ä»£ç å¯¹æ¥</h2><ul><li>é…ç½®æ–‡ä»¶ä¸­å‹¾é€‰Appleå†…åº”ç”¨æ”¯ä»˜ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå¦‚æœä¸å…¨æ˜¯è™šæ‹Ÿå•†å“æˆ–æœåŠ¡çš„(è‹¹æœçš„å†…è´­æ¡ä»¶)ï¼Œåˆ™å¯ä»¥åŒæ—¶é›†æˆåˆ«çš„æ”¯ä»˜ï¼Œå¦‚å¾®ä¿¡æ”¯ä»˜å®ï¼Œåä¹‹åˆ™ä¸è¦å‹¾é€‰ï¼Œä¸ç„¶è‹¹æœä¼šè®¤ä¸ºä½ æœ‰éšè—çš„åŠŸèƒ½ä¼šç»•è¿‡å†…è´­ã€‚<br>  <img src="/images/3389e266531.png" alt="image.png"></li><li>è°ƒç”¨ <code>plus.payment.getChannels</code> æ¥è·å–æ”¯ä»˜é€šé“</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">iospay</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> that = <span class="variable language_">this</span></span><br><span class="line">    uni.<span class="title function_">showLoading</span>(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&#x27;æ£€æµ‹æ”¯ä»˜ç¯å¢ƒ...&#x27;</span>,</span><br><span class="line">        <span class="attr">mask</span>: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">    plus.<span class="property">payment</span>.<span class="title function_">getChannels</span>(<span class="function">(<span class="params">channels</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// console.log(&#x27;channels=&gt;&#x27;, channels)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> channels) &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦è‹¹æœæ”¯ä»˜</span></span><br><span class="line">            <span class="keyword">if</span> (channels[i].<span class="property">id</span> === <span class="string">&#x27;appleiap&#x27;</span>) &#123;</span><br><span class="line">                that.<span class="property">iapChannel</span> = channels[i]</span><br><span class="line">                that.<span class="title function_">requestOrder</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (that.<span class="property">iapChannel</span> == <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">            uni.<span class="title function_">hideLoading</span>()</span><br><span class="line">            uni.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">                <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;æš‚ä¸æ”¯æŒè‹¹æœ iap æ”¯ä»˜&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è°ƒç”¨ä¸Šä¸€æ­¥æ‹¿åˆ°å¯¹è±¡çš„<code>requestOrder</code>æ–¹æ³•<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">requestOrder</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;è·å–è®¢å•ä¿¡æ¯ä¸­...&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> that = <span class="variable language_">this</span></span><br><span class="line">    <span class="comment">// ids æ˜¯å¹³å°ç”³è¯·æ‹¿åˆ°çš„å†…è´­å•†å“çš„id</span></span><br><span class="line">    <span class="keyword">var</span> ids = [that.<span class="property">productId</span>];</span><br><span class="line">    that.<span class="property">iapChannel</span>.<span class="title function_">requestOrder</span>(ids, <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">        <span class="comment">// è·å–è®¢å•ä¿¡æ¯æˆåŠŸå›è°ƒæ–¹æ³•</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;è·å–è®¢å•ä¿¡æ¯æˆåŠŸ=&gt;&#x27;</span>, event)</span><br><span class="line">        uni.<span class="title function_">hideLoading</span>()</span><br><span class="line">        that.<span class="title function_">topay</span>(that.<span class="property">productId</span>)</span><br><span class="line">    &#125;, <span class="keyword">function</span>(<span class="params">erroemsg</span>) &#123;</span><br><span class="line">        <span class="comment">// è·å–è®¢å•ä¿¡æ¯å¤±è´¥å›è°ƒæ–¹æ³•  </span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;requestOrder failed: &#x27;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(erroemsg));</span><br><span class="line">        uni.<span class="title function_">hideLoading</span>()</span><br><span class="line">        uni.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&quot;è·å–æ”¯ä»˜é€šé“å¤±è´¥ï¼š&quot;</span> + errormsg.<span class="property">message</span>,</span><br><span class="line">            <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>æœ€åè°ƒç”¨<code>uni.requestPayment</code>æ‹¿åˆ°åç«¯æ¥å£éœ€è¦çš„äº¤æ˜“idæ ¡éªŒä½“</li><li>æ³¨æ„ï¼šå‘èµ·æ”¯ä»˜å¿…é¡»è¦åœ¨requestOrderä¹‹å<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">topay</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å‘èµ·æ”¯ä»˜ä¸­...&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> that = <span class="variable language_">this</span></span><br><span class="line">    uni.<span class="title function_">showLoading</span>(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&#x27;å……å€¼ä¸­è¯·å‹¿ç¦»å¼€&#x27;</span>,</span><br><span class="line">        <span class="attr">mask</span>: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">    uni.<span class="title function_">requestPayment</span>(&#123;</span><br><span class="line">        <span class="attr">provider</span>: <span class="string">&#x27;appleiap&#x27;</span>,</span><br><span class="line">        <span class="attr">orderInfo</span>: &#123;</span><br><span class="line">            <span class="attr">productid</span>: id <span class="comment">// å†…è´­äº§å“çš„product_id</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">success</span>: (<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ”¯ä»˜æˆåŠŸ&#x27;</span>)</span><br><span class="line">            uni.<span class="title function_">hideLoading</span>()</span><br><span class="line">            <span class="keyword">const</span> orderId = that.<span class="property">orderId</span> <span class="comment">//è¿™ä¸ªè®¢å•id æ˜¯ç”±åç«¯è¿”å›çš„</span></span><br><span class="line">            <span class="keyword">const</span> transactionId = res.<span class="property">transactionIdentifier</span> <span class="comment">//äº¤æ˜“id</span></span><br><span class="line">            <span class="keyword">const</span> payload = res.<span class="property">transactionReceipt</span> <span class="comment">//æ ¡éªŒä½“</span></span><br><span class="line">            <span class="comment">//ç»™è‡ªå·±çš„æœåŠ¡ç«¯é€šçŸ¥ï¼ŒæœåŠ¡ç«¯åšæ ¡éªŒå’Œæ”¯ä»˜æˆåŠŸçš„ä¸šåŠ¡</span></span><br><span class="line">            <span class="keyword">let</span> url = <span class="string">&#x27;/api/user/iosNotify&#x27;</span>;</span><br><span class="line">            <span class="keyword">let</span> parames = &#123;</span><br><span class="line">                <span class="attr">transactionId</span>: transactionId,</span><br><span class="line">                <span class="attr">payload</span>: payload,</span><br><span class="line">                <span class="attr">orderId</span>: orderId</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;iosNotifyParames=&gt;&#x27;</span>, parames)</span><br><span class="line">            <span class="variable language_">this</span>.$myRequest(&#123;</span><br><span class="line">                <span class="attr">url</span>: url,</span><br><span class="line">                <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">                <span class="attr">data</span>: parames</span><br><span class="line">            &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                uni.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">                    <span class="attr">icon</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">                    <span class="attr">title</span>: <span class="string">&#x27;æ”¯ä»˜æˆåŠŸ&#x27;</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="attr">fail</span>: <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ”¯ä»˜å¤±è´¥=&gt;&#x27;</span>, e)</span><br><span class="line">            uni.<span class="title function_">hideLoading</span>()</span><br><span class="line">            uni.<span class="title function_">showModal</span>(&#123;</span><br><span class="line">                <span class="attr">content</span>: <span class="string">&quot;æ”¯ä»˜å¤±è´¥&quot;</span>,</span><br><span class="line">                <span class="attr">showCancel</span>: <span class="literal">false</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜"><a href="#è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜" class="headerlink" title="è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜"></a>è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜</h2><ul><li><p>æµ‹è¯•æ”¯ä»˜éœ€è¦é…ç½®æ²™ç®±æµ‹è¯•è´¦å·</p><p>  æ–°çš„å†…è´­äº§å“ä¸Šçº¿ä¹‹å‰ï¼Œæµ‹è¯•äººå‘˜ä¸€èˆ¬éœ€è¦å¯¹å†…è´­äº§å“è¿›è¡Œæµ‹è¯•ï¼Œä½†æ˜¯å†…è´­æ¶‰åŠåˆ°é’±ï¼Œæ‰€ä»¥è‹¹æœä¸ºå†…è´­æµ‹è¯•æä¾›äº† æ²™ç®±æµ‹è¯•è´¦å· çš„åŠŸèƒ½ï¼ŒApple Pay æ¨å‡ºä¹‹å æ²™ç®±æµ‹è¯•è´¦å·ï¼Œä¹Ÿå¯ä»¥ç”¨äº Apple Pay æ”¯ä»˜çš„æµ‹è¯•ï¼Œæ²™ç®±æµ‹è¯•è´¦å· ç®€å•ç†è§£å°±æ˜¯ï¼šåªèƒ½ç”¨äºå†…è´­å’Œ Apple Pay æµ‹è¯•åŠŸèƒ½çš„ Apple IDï¼Œå®ƒå¹¶ä¸æ˜¯çœŸå®çš„ Apple IDã€‚</p><p>  å¡«å†™æ²™ç®±æµ‹è¯•è´¦å·ä¿¡æ¯éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>ç”µå­é‚®ä»¶ä¸èƒ½æ˜¯åˆ«äººå·²ç»æ³¨å†Œè¿‡ AppleID çš„é‚®ç®±</li><li>ç”µå­é‚®ç®±å¯ä»¥ä¸æ˜¯çœŸå®çš„é‚®ç®±ï¼Œä½†æ˜¯å¿…é¡»ç¬¦åˆé‚®ç®±æ ¼å¼</li><li>App Store åœ°åŒºçš„é€‰æ‹©ï¼Œæµ‹è¯•çš„æ—¶å€™å¼¹å‡ºçš„æç¤ºæ¡†ä»¥åŠç»“ç®—çš„ä»·æ ¼ä¼šæŒ‰ç…§æ²™ç®±è´¦å·é€‰æ‹©çš„åœ°åŒºæ¥ï¼Œå»ºè®®æµ‹è¯•çš„æ—¶å€™æ–°å»ºå‡ ä¸ªä¸åŒåœ°åŒºçš„è´¦å·è¿›è¡Œæµ‹è¯•ï¼ï¼ï¼</li></ul><p>  æ²™ç®±è´¦å·æµ‹è¯•çš„ä½¿ç”¨ï¼š</p><ul><li>é¦–å…ˆæ²™ç®±æµ‹è¯•è´¦å·å¿…é¡»åœ¨çœŸæœºç¯å¢ƒä¸‹è¿›è¡Œæµ‹è¯•ï¼Œå¹¶ä¸”æ˜¯ adhoc è¯ä¹¦æˆ–è€… develop è¯ä¹¦ç­¾åçš„å®‰è£…åŒ…ï¼Œæ²™ç›’è´¦å·ä¸æ”¯æŒç›´æ¥ä» App Store ä¸‹è½½çš„å®‰è£…åŒ…</li><li>å»çœŸæœºçš„ App Store é€€å‡ºçœŸå®çš„ Apple ID è´¦å·ï¼Œé€€å‡ºä¹‹åå¹¶ä¸éœ€è¦åœ¨App Store é‡Œé¢ç™»å½•æ²™ç®±æµ‹è¯•è´¦å·</li><li>ç„¶åå» App é‡Œé¢æµ‹è¯•è´­ä¹°å•†å“ï¼Œä¼šå¼¹å‡ºç™»å½•æ¡†ï¼Œé€‰æ‹© <code>ä½¿ç”¨ç°æœ‰çš„ Apple ID</code>ï¼Œç„¶åç™»å½•æ²™ç®±æµ‹è¯•è´¦å·ï¼Œç™»å½•æˆåŠŸä¹‹åä¼šå¼¹å‡ºè´­ä¹°æç¤ºæ¡†ï¼Œç‚¹å‡» <code>è´­ä¹°</code>ï¼Œç„¶åä¼šå¼¹å‡ºæç¤ºæ¡†å®Œæˆè´­ä¹°ã€‚</li></ul></li><li><p><code>requestOrder</code>å‡½æ•°æˆåŠŸå’Œå¤±è´¥çš„å›è°ƒéƒ½æ²¡å“åº”</p><ul><li>æ£€æŸ¥å†…è´­äº§å“å’Œç¨åŠ¡æ˜¯å¦å®Œå–„</li></ul></li><li><p><code>requestPayment</code>é¡µé¢æç¤ºæ”¯ä»˜æˆåŠŸï¼Œä½†æ˜¯<code>success</code>å›è°ƒæ— å“åº”</p><ul><li>æ²™ç®±çš„å›è°ƒç‰¹åˆ«ç‰¹åˆ«æ…¢ä¸”éšç¼˜â€¦</li><li>æ”¯ä»˜æˆåŠŸåï¼Œæ€æ­»appé‡æ–°è¿›å…¥ï¼Œå†æ¬¡å”¤èµ·æ”¯ä»˜ï¼Œä¸Šæ¬¡çš„å›è°ƒæœ‰â€˜å‡ ç‡â€™æ‹¿åˆ°ã€‚</li></ul></li></ul><p>ä¸ªäººæ€»ç»“ï¼Œå¦‚æœ‰ä¸å¦¥ä¹‹å¤„ï¼Œçƒ¦è¯·æŒ‡å‡ºã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> UniApp </tag>
            
            <tag> ApplePay </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
